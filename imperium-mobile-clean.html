<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>IMPERIUM Mobile - Roma Aeterna V20 CLEAN</title>
    
    <!-- PWA et Icônes -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">
    
    <!-- CSS mobile optimisé (SEUL SYSTÈME D'INTERFACE) -->
    <style>
        /* Reset complet et suppression d'interférences */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Masquer toute interface non-mobile qui pourrait apparaître */
        .desktop-ui, .popup-overlay, .old-menu, .nav-menu, 
        .desktop-header, .desktop-sidebar, .legacy-ui {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        :root {
            /* Couleurs thème romain */
            --gold-primary: #d97706;
            --gold-secondary: #f59e0b;
            --gold-light: #fbbf24;
            --marble-white: #f8fafc;
            --roman-red: #dc2626;
            --roman-purple: #7c3aed;
            --dark-stone: #1e293b;
            --dark-marble: #334155;
            --dark-bg: #0f172a;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border-gold: rgba(217, 119, 6, 0.3);
            --shadow-gold: rgba(217, 119, 6, 0.4);
            --success-green: #22c55e;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            
            /* Variables mobiles */
            --mobile-touch-size: 44px;
            --mobile-spacing: 16px;
            --mobile-border-radius: 12px;
            --mobile-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --mobile-shadow-active: 0 2px 8px rgba(0, 0, 0, 0.25);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100vh;
            height: 100svh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
            color: var(--text-light);
            touch-action: manipulation;
            position: relative;
        }

        /* Conteneur principal mobile SEUL */
        .mobile-game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100svh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            z-index: 999999;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
        }

        /* Header mobile */
        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--safe-area-top) + 12px) 16px 12px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-gold);
            z-index: 1000000;
            min-height: calc(var(--mobile-touch-size) + var(--safe-area-top));
            position: relative;
        }

        .mobile-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold-primary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            font-family: serif;
        }

        .mobile-resources {
            display: flex;
            gap: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            background: rgba(217, 119, 6, 0.15);
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid var(--border-gold);
            min-height: 32px;
            backdrop-filter: blur(10px);
        }

        /* Zone de jeu principale */
        .mobile-game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 25% 25%, rgba(217, 119, 6, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(124, 58, 237, 0.03) 0%, transparent 50%);
        }

        /* Vues du jeu */
        .game-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .game-view.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* Grille de bâtiments */
        .mobile-buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 12px;
            padding-bottom: 20px;
        }

        .mobile-building-slot {
            aspect-ratio: 1;
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            min-height: 80px;
            touch-action: manipulation;
            backdrop-filter: blur(5px);
        }

        .mobile-building-slot:active {
            transform: scale(0.95);
            box-shadow: var(--mobile-shadow-active);
        }

        .mobile-building-slot.occupied {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(251, 191, 36, 0.15));
            border-color: var(--gold-primary);
            box-shadow: var(--mobile-shadow);
        }

        .building-icon-mobile {
            font-size: 2rem;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .building-name-mobile {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-light);
            line-height: 1.2;
        }

        .building-level-mobile {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--gold-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            border: 2px solid var(--dark-bg);
        }

        /* Vue Armée */
        .army-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .army-category-btn {
            flex: 1;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-gold);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
        }

        .army-category-btn.active {
            background: var(--gold-primary);
            color: white;
            box-shadow: var(--mobile-shadow);
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .unit-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            padding: 16px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .unit-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .unit-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .unit-count {
            color: var(--gold-light);
            font-size: 0.9rem;
        }

        /* Barre d'actions mobile */
        .mobile-action-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 16px calc(var(--safe-area-bottom) + 12px);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-gold);
            z-index: 1000000;
            gap: 8px;
            min-height: calc(var(--mobile-touch-size) + var(--safe-area-bottom) + 24px);
            position: relative;
        }

        .mobile-action-btn {
            flex: 1;
            max-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            background: linear-gradient(145deg, var(--gold-secondary), var(--gold-primary));
            border: none;
            border-radius: var(--mobile-border-radius);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
            text-align: center;
            touch-action: manipulation;
        }

        .mobile-action-btn:active {
            transform: scale(0.95);
            background: linear-gradient(145deg, var(--gold-primary), var(--gold-secondary));
        }

        .mobile-action-btn.active {
            background: linear-gradient(145deg, var(--roman-purple), var(--gold-primary));
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.6);
        }

        .mobile-action-btn .icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        /* Menu contextuel mobile */
        .mobile-context-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(25px);
            border: 2px solid var(--gold-primary);
            border-radius: 20px;
            padding: 20px;
            z-index: 10000000;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .context-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-gold);
        }

        .context-menu-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--gold-light);
        }

        .context-menu-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            min-width: var(--mobile-touch-size);
            min-height: var(--mobile-touch-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            touch-action: manipulation;
        }

        .context-menu-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-options {
            display: grid;
            gap: 12px;
        }

        .context-menu-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
            touch-action: manipulation;
        }

        .context-menu-option:active {
            transform: scale(0.98);
            background: rgba(217, 119, 6, 0.15);
            border-color: var(--gold-primary);
        }

        .context-menu-option .icon {
            font-size: 1.5rem;
            width: 32px;
            text-align: center;
        }

        .context-menu-option .content {
            flex: 1;
        }

        .context-menu-option .title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .context-menu-option .description {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        /* Notifications */
        .mobile-notification {
            position: fixed;
            top: calc(var(--safe-area-top) + 80px);
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 10000001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            color: white;
            transition: all 0.3s ease;
            max-width: 90vw;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .mobile-notification-success { background: var(--success-green); }
        .mobile-notification-error { background: var(--error-red); }
        .mobile-notification-info { background: var(--info-blue); }

        /* Overlay */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Responsive */
        @media (max-width: 360px) {
            .mobile-buildings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .resource-item {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .mobile-action-btn {
                font-size: 0.6rem;
                padding: 6px 2px;
            }
        }

        @media (max-height: 600px) {
            .mobile-header, .mobile-action-bar {
                padding-top: calc(var(--safe-area-top) + 8px);
                padding-bottom: calc(var(--safe-area-bottom) + 8px);
            }
        }
    </style>
</head>
<body>
    <!-- INTERFACE MOBILE UNIQUE -->
    <div class="mobile-game-container" id="mobile-game-container">
        <!-- Header -->
        <div class="mobile-header">
            <div class="mobile-logo">IMPERIUM</div>
            <div class="mobile-resources" id="mobile-resources">
                <div class="resource-item">
                    <span>🏛️</span>
                    <span id="mobile-gold">1000</span>
                </div>
                <div class="resource-item">
                    <span>🌾</span>
                    <span id="mobile-food">500</span>
                </div>
                <div class="resource-item">
                    <span>⚪</span>
                    <span id="mobile-marble">100</span>
                </div>
            </div>
        </div>
        
        <!-- Zone de jeu principale -->
        <div class="mobile-game-area" id="mobile-game-area">
            <!-- Vue Cité -->
            <div class="game-view city-view active" id="city-view">
                <div class="mobile-buildings-grid" id="mobile-buildings-grid">
                    <!-- Généré dynamiquement -->
                </div>
            </div>
            
            <!-- Vue Monde -->
            <div class="game-view world-view" id="world-view">
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: var(--gold-primary); margin-bottom: 20px;">🗺️ Carte du Monde</h2>
                    <div style="background: rgba(30,41,59,0.6); border-radius: 15px; padding: 30px; border: 1px solid var(--border-gold);">
                        <p>Explorez l'empire romain et conquérez de nouveaux territoires!</p>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; margin: 10px; padding: 15px; background: var(--roman-red); border-radius: 10px;">
                                🏛️ Rome (Capital)
                            </div>
                            <div style="display: inline-block; margin: 10px; padding: 15px; background: var(--dark-marble); border-radius: 10px;">
                                🏞️ Gaule (À conquérir)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vue Armée -->
            <div class="game-view army-view" id="army-view">
                <div class="army-categories">
                    <button class="army-category-btn active" data-category="land">🏛️ Terrestres</button>
                    <button class="army-category-btn" data-category="sea">⚓ Navales</button>
                </div>
                <div class="units-grid" id="units-grid">
                    <!-- Généré dynamiquement -->
                </div>
            </div>
        </div>
        
        <!-- Barre d'actions -->
        <div class="mobile-action-bar" id="mobile-action-bar">
            <button class="mobile-action-btn active" data-action="city">
                <div class="icon">🏛️</div>
                <div>Cité</div>
            </button>
            <button class="mobile-action-btn" data-action="world">
                <div class="icon">🌍</div>
                <div>Monde</div>
            </button>
            <button class="mobile-action-btn" data-action="army">
                <div class="icon">⚔️</div>
                <div>Armée</div>
            </button>
            <button class="mobile-action-btn" data-action="trade">
                <div class="icon">🏪</div>
                <div>Commerce</div>
            </button>
            <button class="mobile-action-btn" data-action="menu">
                <div class="icon">⚙️</div>
                <div>Menu</div>
            </button>
        </div>
    </div>

    <!-- Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>

    <!-- SCRIPTS ESSENTIELS SEULEMENT -->
    <script src="js/game.js"></script>

    <!-- SCRIPT MOBILE AUTONOME -->
    <script>
        // ===============================================================
        // IMPERIUM V20 MOBILE - VERSION AUTONOME SANS CONFLITS
        // ===============================================================
        
        // Désactiver tous les anciens systèmes d'interface
        document.addEventListener('DOMContentLoaded', function() {
            // Masquer toute interface non-mobile
            const oldInterfaces = document.querySelectorAll('.desktop-ui, .popup-overlay, .old-menu, .nav-menu, .desktop-header, .desktop-sidebar, .legacy-ui');
            oldInterfaces.forEach(el => {
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.opacity = '0';
                el.style.pointerEvents = 'none';
            });
            
            // Désactiver les événements des anciens systèmes
            window.showPopup = function() { console.log('Popup désactivé en mode mobile'); };
            window.openMenu = function() { console.log('Menu desktop désactivé'); };
            
            console.log('🏛️ Interface mobile pure activée - Anciens systèmes désactivés');
        });
        
        class ImperiumMobileClean {
            constructor() {
                this.currentView = 'city';
                this.gameState = {
                    resources: { gold: 1000, food: 500, marble: 100, wood: 200 },
                    buildings: {},
                    army: { land: {}, sea: {} },
                    level: 1,
                    xp: 0
                };
                this.initialized = false;
            }

            async initialize() {
                if (this.initialized) return;
                
                console.log('🏛️ Initialisation IMPERIUM Mobile Clean...');
                
                // Charger sauvegarde si disponible
                this.loadSavedGame();
                
                // Configurer interface
                this.setupEventHandlers();
                this.updateDisplay();
                
                // Démarrer boucles de jeu
                this.startGameLoop();
                
                this.initialized = true;
                this.showNotification('🏛️ Bienvenue dans IMPERIUM!', 'success');
            }

            setupEventHandlers() {
                // Actions principales
                const actionBar = document.getElementById('mobile-action-bar');
                actionBar.addEventListener('click', (e) => {
                    const button = e.target.closest('.mobile-action-btn');
                    if (!button) return;
                    
                    const action = button.getAttribute('data-action');
                    this.handleAction(action, button);
                    
                    // Feedback tactile
                    if ('vibrate' in navigator) {
                        navigator.vibrate(50);
                    }
                });

                // Construction
                const buildingsGrid = document.getElementById('mobile-buildings-grid');
                buildingsGrid.addEventListener('click', (e) => {
                    const slot = e.target.closest('.mobile-building-slot');
                    if (!slot) return;
                    
                    const slotIndex = parseInt(slot.getAttribute('data-slot'));
                    this.handleBuildingClick(slotIndex);
                });

                // Catégories d'armée
                document.addEventListener('click', (e) => {
                    const categoryBtn = e.target.closest('.army-category-btn');
                    if (!categoryBtn) return;
                    
                    document.querySelectorAll('.army-category-btn').forEach(btn => btn.classList.remove('active'));
                    categoryBtn.classList.add('active');
                    this.updateArmyView();
                });

                // Overlay
                const overlay = document.getElementById('mobile-overlay');
                overlay.addEventListener('click', () => this.closeAllMenus());

                // Gestures tactiles
                this.setupTouchGestures();
            }

            setupTouchGestures() {
                let startX, startY;
                
                document.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                document.addEventListener('touchend', (e) => {
                    if (!startX || !startY) return;
                    
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    
                    const diffX = startX - endX;
                    const diffY = startY - endY;
                    
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                        if (diffX > 0) this.swipeLeft();
                        else this.swipeRight();
                    }
                    
                    startX = startY = null;
                }, { passive: true });
            }

            swipeLeft() {
                const views = ['city', 'world', 'army'];
                const currentIndex = views.indexOf(this.currentView);
                const nextIndex = (currentIndex + 1) % views.length;
                this.switchToView(views[nextIndex]);
                this.updateActiveButton(nextIndex);
            }

            swipeRight() {
                const views = ['city', 'world', 'army'];
                const currentIndex = views.indexOf(this.currentView);
                const prevIndex = (currentIndex - 1 + views.length) % views.length;
                this.switchToView(views[prevIndex]);
                this.updateActiveButton(prevIndex);
            }

            handleAction(action, button) {
                console.log(`📱 Action: ${action}`);
                
                switch (action) {
                    case 'city':
                        this.switchToView('city');
                        break;
                    case 'world':
                        this.switchToView('world');
                        break;
                    case 'army':
                        this.switchToView('army');
                        break;
                    case 'trade':
                        this.showTradeMenu();
                        break;
                    case 'menu':
                        this.showMainMenu();
                        break;
                }

                // Mettre à jour bouton actif
                document.querySelectorAll('.mobile-action-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            }

            switchToView(viewName) {
                if (this.currentView === viewName) return;
                
                // Changer vue
                document.querySelector('.game-view.active').classList.remove('active');
                document.getElementById(`${viewName}-view`).classList.add('active');
                
                this.currentView = viewName;
                this.updateView();
            }

            updateView() {
                switch (this.currentView) {
                    case 'city':
                        this.updateCityView();
                        break;
                    case 'army':
                        this.updateArmyView();
                        break;
                }
            }

            updateCityView() {
                const grid = document.getElementById('mobile-buildings-grid');
                grid.innerHTML = '';
                
                // Créer 15 slots de bâtiments
                for (let i = 0; i < 15; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'mobile-building-slot';
                    slot.setAttribute('data-slot', i);
                    
                    const building = this.gameState.buildings[i];
                    if (building) {
                        const buildingData = this.getBuildingData(building.type);
                        slot.classList.add('occupied');
                        slot.innerHTML = `
                            <div class="building-icon-mobile">${buildingData.icon}</div>
                            <div class="building-name-mobile">${buildingData.name}</div>
                            <div class="building-level-mobile">${building.level}</div>
                        `;
                    } else {
                        slot.innerHTML = `
                            <div class="building-icon-mobile">➕</div>
                            <div class="building-name-mobile">Construire</div>
                        `;
                    }
                    
                    grid.appendChild(slot);
                }
            }

            updateArmyView() {
                const unitsGrid = document.getElementById('units-grid');
                const activeCategory = document.querySelector('.army-category-btn.active').getAttribute('data-category');
                
                unitsGrid.innerHTML = '';
                
                const units = this.getUnitsForCategory(activeCategory);
                units.forEach(unit => {
                    const count = this.gameState.army[activeCategory][unit.type] || 0;
                    
                    const unitCard = document.createElement('div');
                    unitCard.className = 'unit-card';
                    unitCard.innerHTML = `
                        <div class="unit-icon">${unit.icon}</div>
                        <div class="unit-name">${unit.name}</div>
                        <div class="unit-count">${count}</div>
                        <button style="margin-top: 8px; padding: 6px 12px; background: var(--gold-primary); color: white; border: none; border-radius: 15px; font-size: 0.8rem;" onclick="game.trainUnit('${unit.type}')">
                            Entraîner
                        </button>
                    `;
                    
                    unitsGrid.appendChild(unitCard);
                });
            }

            handleBuildingClick(slotIndex) {
                const building = this.gameState.buildings[slotIndex];
                
                if (building) {
                    this.showBuildingMenu(slotIndex, building);
                } else {
                    this.showBuildingSelector(slotIndex);
                }
            }

            showBuildingSelector(slotIndex) {
                const menu = this.createContextMenu('Construire un bâtiment');
                const options = menu.querySelector('.context-menu-options');
                
                const buildings = this.getAvailableBuildings();
                buildings.forEach(building => {
                    if (this.canAfford(building.cost)) {
                        const option = document.createElement('div');
                        option.className = 'context-menu-option';
                        option.innerHTML = `
                            <div class="icon">${building.icon}</div>
                            <div class="content">
                                <div class="title">${building.name}</div>
                                <div class="description">${building.description}</div>
                            </div>
                        `;
                        
                        option.addEventListener('click', () => {
                            this.buildBuilding(slotIndex, building.type);
                            this.closeAllMenus();
                        });
                        
                        options.appendChild(option);
                    }
                });
                
                this.showMenu(menu);
            }

            showMainMenu() {
                const menu = this.createContextMenu('Menu Principal');
                const options = menu.querySelector('.context-menu-options');
                
                const menuItems = [
                    { icon: '💾', title: 'Sauvegarder', description: 'Sauvegarder votre progression', action: () => this.saveGame() },
                    { icon: '📁', title: 'Charger', description: 'Charger une sauvegarde', action: () => this.loadGame() },
                    { icon: '🔄', title: 'Redémarrer', description: 'Nouvelle partie', action: () => this.resetGame() },
                    { icon: '❓', title: 'Aide', description: 'Guide du jeu', action: () => this.showHelp() }
                ];
                
                menuItems.forEach(item => {
                    const option = document.createElement('div');
                    option.className = 'context-menu-option';
                    option.innerHTML = `
                        <div class="icon">${item.icon}</div>
                        <div class="content">
                            <div class="title">${item.title}</div>
                            <div class="description">${item.description}</div>
                        </div>
                    `;
                    
                    option.addEventListener('click', () => {
                        item.action();
                        this.closeAllMenus();
                        this.showNotification(`${item.title} effectué!`, 'success');
                    });
                    
                    options.appendChild(option);
                });
                
                this.showMenu(menu);
            }

            showTradeMenu() {
                this.showNotification('🏪 Commerce disponible bientôt!', 'info');
            }

            createContextMenu(title) {
                const menu = document.createElement('div');
                menu.className = 'mobile-context-menu';
                menu.innerHTML = `
                    <div class="context-menu-header">
                        <div class="context-menu-title">${title}</div>
                        <button class="context-menu-close">×</button>
                    </div>
                    <div class="context-menu-options"></div>
                `;
                
                menu.querySelector('.context-menu-close').addEventListener('click', () => this.closeAllMenus());
                return menu;
            }

            showMenu(menu) {
                document.body.appendChild(menu);
                document.getElementById('mobile-overlay').classList.add('active');
            }

            closeAllMenus() {
                document.querySelectorAll('.mobile-context-menu').forEach(menu => menu.remove());
                document.getElementById('mobile-overlay').classList.remove('active');
            }

            buildBuilding(slotIndex, buildingType) {
                const building = this.getBuildingData(buildingType);
                
                if (!this.canAfford(building.cost)) {
                    this.showNotification('Ressources insuffisantes!', 'error');
                    return;
                }
                
                // Déduire coûts
                Object.entries(building.cost).forEach(([resource, amount]) => {
                    this.gameState.resources[resource] -= amount;
                });
                
                // Créer bâtiment
                this.gameState.buildings[slotIndex] = {
                    type: buildingType,
                    level: 1
                };
                
                this.showNotification(`${building.name} construit!`, 'success');
                this.updateDisplay();
                this.saveGame();
            }

            trainUnit(unitType) {
                const unit = this.getUnitData(unitType);
                
                if (!this.canAfford(unit.cost)) {
                    this.showNotification('Ressources insuffisantes!', 'error');
                    return;
                }
                
                // Déduire coûts
                Object.entries(unit.cost).forEach(([resource, amount]) => {
                    this.gameState.resources[resource] -= amount;
                });
                
                // Ajouter unité
                const domain = unit.domain;
                if (!this.gameState.army[domain][unitType]) {
                    this.gameState.army[domain][unitType] = 0;
                }
                this.gameState.army[domain][unitType]++;
                
                this.showNotification(`${unit.name} entraîné!`, 'success');
                this.updateDisplay();
                this.saveGame();
            }

            canAfford(cost) {
                return Object.entries(cost).every(([resource, amount]) => 
                    (this.gameState.resources[resource] || 0) >= amount
                );
            }

            updateDisplay() {
                this.updateResourcesDisplay();
                this.updateView();
            }

            updateResourcesDisplay() {
                document.getElementById('mobile-gold').textContent = this.formatNumber(this.gameState.resources.gold || 0);
                document.getElementById('mobile-food').textContent = this.formatNumber(this.gameState.resources.food || 0);
                document.getElementById('mobile-marble').textContent = this.formatNumber(this.gameState.resources.marble || 0);
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            updateActiveButton(index) {
                const buttons = document.querySelectorAll('.mobile-action-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                if (buttons[index]) buttons[index].classList.add('active');
            }

            startGameLoop() {
                setInterval(() => {
                    this.gameLoop();
                }, 2000);

                // Auto-save
                setInterval(() => {
                    this.saveGame();
                }, 30000);
            }

            gameLoop() {
                // Production passive
                let goldProduction = 0;
                let foodProduction = 0;
                
                Object.values(this.gameState.buildings).forEach(building => {
                    const data = this.getBuildingData(building.type);
                    if (data.production) {
                        goldProduction += data.production.gold || 0;
                        foodProduction += data.production.food || 0;
                    }
                });
                
                this.gameState.resources.gold += goldProduction;
                this.gameState.resources.food += foodProduction;
                
                this.updateResourcesDisplay();
            }

            saveGame() {
                try {
                    localStorage.setItem('imperium_mobile_clean', JSON.stringify(this.gameState));
                    console.log('💾 Jeu sauvegardé');
                } catch (error) {
                    console.error('❌ Erreur sauvegarde:', error);
                }
            }

            loadSavedGame() {
                try {
                    const saved = localStorage.getItem('imperium_mobile_clean');
                    if (saved) {
                        this.gameState = { ...this.gameState, ...JSON.parse(saved) };
                        console.log('📁 Sauvegarde chargée');
                    }
                } catch (error) {
                    console.error('❌ Erreur chargement:', error);
                }
            }

            resetGame() {
                localStorage.removeItem('imperium_mobile_clean');
                location.reload();
            }

            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `mobile-notification mobile-notification-${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }

            // Données du jeu simplifiées
            getBuildingData(type) {
                const buildings = {
                    farm: { icon: '🌾', name: 'Ferme', description: 'Produit de la nourriture', cost: { gold: 100 }, production: { food: 2 } },
                    market: { icon: '🏪', name: 'Marché', description: 'Génère de l\'or', cost: { gold: 150, wood: 50 }, production: { gold: 3 } },
                    barracks: { icon: '🏛️', name: 'Caserne', description: 'Entraîne des soldats', cost: { gold: 200, marble: 50 } },
                    temple: { icon: '⛩️', name: 'Temple', description: 'Augmente le bonheur', cost: { gold: 300, marble: 100 } },
                    warehouse: { icon: '📦', name: 'Entrepôt', description: 'Stocke des ressources', cost: { gold: 120, wood: 80 } }
                };
                return buildings[type] || buildings.farm;
            }

            getUnitData(type) {
                const units = {
                    legionnaire: { icon: '🛡️', name: 'Légionnaire', description: 'Soldat de base', cost: { gold: 50, food: 20 }, domain: 'land' },
                    archer: { icon: '🏹', name: 'Archer', description: 'Unité à distance', cost: { gold: 60, wood: 30 }, domain: 'land' },
                    cavalry: { icon: '🐎', name: 'Cavalerie', description: 'Unité rapide', cost: { gold: 100, food: 40 }, domain: 'land' },
                    galley: { icon: '⛵', name: 'Galère', description: 'Navire de guerre', cost: { gold: 200, wood: 150 }, domain: 'sea' }
                };
                return units[type] || units.legionnaire;
            }

            getAvailableBuildings() {
                return [
                    { type: 'farm', ...this.getBuildingData('farm') },
                    { type: 'market', ...this.getBuildingData('market') },
                    { type: 'barracks', ...this.getBuildingData('barracks') },
                    { type: 'temple', ...this.getBuildingData('temple') },
                    { type: 'warehouse', ...this.getBuildingData('warehouse') }
                ];
            }

            getUnitsForCategory(category) {
                const allUnits = [
                    { type: 'legionnaire', ...this.getUnitData('legionnaire') },
                    { type: 'archer', ...this.getUnitData('archer') },
                    { type: 'cavalry', ...this.getUnitData('cavalry') },
                    { type: 'galley', ...this.getUnitData('galley') }
                ];
                return allUnits.filter(unit => unit.domain === category);
            }

            showHelp() {
                this.showNotification('❓ Guide: Construisez, entraînez, conquérez!', 'info', 5000);
            }
        }

        // Instance globale
        const game = new ImperiumMobileClean();
        window.game = game;
        
        // Initialisation automatique
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Lancement IMPERIUM Mobile Clean...');
            setTimeout(() => {
                game.initialize();
            }, 500);
        });

        // Sauvegarde automatique
        window.addEventListener('beforeunload', () => {
            if (game.initialized) {
                game.saveGame();
            }
        });
    </script>
</body>
</html>