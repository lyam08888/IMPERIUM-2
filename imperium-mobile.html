<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>IMPERIUM Mobile - Roma Aeterna</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">
    
    <!-- CSS optimisations mobiles -->
    <link rel="stylesheet" href="css/mobile-touch.css">
    
    <!-- Scripts de jeu -->
    <script src="js/game.js" defer></script>
    <script src="js/shared-utils.js" defer></script>
    <script src="js/unified-popup-system.js" defer></script>
    <script src="js/unified-game-controller.js" defer></script>
    <script src="js/scenario.js" defer></script>
    <script src="js/city-view.js" defer></script>
    <script src="js/world-view.js" defer></script>
    <script src="js/BattleManager.js" defer></script>
    <script src="js/simulator-view.js" defer></script>
    <script src="js/maritime-simulator-view.js" defer></script>
    <script src="js/imperium_popup.js" defer></script>

    <style>
        /* Reset et optimisations mobiles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --gold-primary: #d97706;
            --gold-secondary: #f59e0b;
            --gold-light: #fbbf24;
            --marble-white: #f8fafc;
            --roman-red: #dc2626;
            --roman-purple: #7c3aed;
            --dark-stone: #1e293b;
            --dark-marble: #334155;
            --dark-bg: #0f172a;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border-gold: rgba(217, 119, 6, 0.3);
            --shadow-gold: rgba(217, 119, 6, 0.4);
            --success-green: #22c55e;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            
            /* Nouveaux tokens pour mobile */
            --mobile-touch-size: 44px; /* Taille minimale recommandée pour les zones tactiles */
            --mobile-spacing: 16px;
            --mobile-border-radius: 12px;
            --mobile-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --mobile-shadow-active: 0 2px 8px rgba(0, 0, 0, 0.25);
        }

        html, body {
            height: 100vh;
            height: 100svh; /* Support pour les nouveaux navigateurs */
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
            color: var(--text-light);
            touch-action: pan-x pan-y;
        }

        /* Interface mobile principale */
        .mobile-game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100svh;
            position: relative;
            overflow: hidden;
        }

        /* Header mobile compact */
        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: max(env(safe-area-inset-top), 12px) 16px 12px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-gold);
            z-index: 100;
            min-height: var(--mobile-touch-size);
        }

        .mobile-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold-primary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mobile-resources {
            display: flex;
            gap: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            background: rgba(217, 119, 6, 0.1);
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid var(--border-gold);
            min-height: 32px;
        }

        /* Zone de jeu principale */
        .mobile-game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 25% 25%, rgba(217, 119, 6, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(124, 58, 237, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
        }

        /* Grille de bâtiments mobile-optimisée */
        .mobile-buildings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 400px) {
            .mobile-buildings-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 600px) {
            .mobile-buildings-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .mobile-building-slot {
            aspect-ratio: 1;
            background: rgba(30, 41, 59, 0.4);
            border: 2px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            min-height: 80px;
            touch-action: manipulation;
        }

        .mobile-building-slot:active {
            transform: scale(0.95);
            box-shadow: var(--mobile-shadow-active);
        }

        .mobile-building-slot.occupied {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.15), rgba(251, 191, 36, 0.1));
            border-color: var(--gold-primary);
            box-shadow: var(--mobile-shadow);
        }

        .mobile-building-slot:not(.occupied):active {
            border-color: var(--gold-light);
            background: rgba(217, 119, 6, 0.1);
        }

        .building-icon-mobile {
            font-size: 2rem;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .building-name-mobile {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-light);
            line-height: 1.2;
        }

        .building-level-mobile {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--gold-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            border: 2px solid var(--dark-bg);
        }

        .construction-progress-mobile {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0 0 var(--mobile-border-radius) var(--mobile-border-radius);
            overflow: hidden;
        }

        .progress-bar-mobile {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-light));
            transition: width 0.3s ease;
        }

        /* Barre d'actions mobile */
        .mobile-action-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: max(env(safe-area-inset-bottom), 12px) 16px 12px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-gold);
            z-index: 100;
            gap: 8px;
        }

        .mobile-action-btn {
            flex: 1;
            max-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            background: linear-gradient(145deg, var(--gold-secondary), var(--gold-primary));
            border: none;
            border-radius: var(--mobile-border-radius);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
            text-align: center;
            touch-action: manipulation;
        }

        .mobile-action-btn:active {
            transform: scale(0.95);
            background: linear-gradient(145deg, var(--gold-primary), var(--gold-secondary));
        }

        .mobile-action-btn .icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        /* Menu contextuel mobile */
        .mobile-context-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid var(--gold-primary);
            border-radius: 20px;
            padding: 20px;
            z-index: 1000;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .mobile-context-menu.hidden {
            display: none;
        }

        .context-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-gold);
        }

        .context-menu-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--gold-light);
        }

        .context-menu-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            min-width: var(--mobile-touch-size);
            min-height: var(--mobile-touch-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            touch-action: manipulation;
        }

        .context-menu-close:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Options de menu */
        .context-menu-options {
            display: grid;
            gap: 12px;
        }

        .context-menu-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
            touch-action: manipulation;
        }

        .context-menu-option:active {
            transform: scale(0.98);
            background: rgba(217, 119, 6, 0.1);
            border-color: var(--gold-primary);
        }

        .context-menu-option .icon {
            font-size: 1.5rem;
            width: 32px;
            text-align: center;
        }

        .context-menu-option .content {
            flex: 1;
        }

        .context-menu-option .title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .context-menu-option .description {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        /* Overlay pour fermer les menus */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(5px);
            touch-action: none;
        }

        .mobile-overlay.hidden {
            display: none;
        }

        /* Notifications mobile */
        .mobile-notifications {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 80px);
            left: 16px;
            right: 16px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .mobile-notification {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            padding: 12px 16px;
            color: var(--text-light);
            font-size: 0.9rem;
            animation: slideInFromTop 0.3s ease;
            pointer-events: auto;
        }

        .mobile-notification.success {
            border-color: var(--success-green);
            background: rgba(34, 197, 94, 0.1);
        }

        .mobile-notification.error {
            border-color: var(--error-red);
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes slideInFromTop {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Gestes tactiles */
        .swipeable {
            touch-action: pan-y;
        }

        /* Adaptations pour différentes tailles */
        @media (max-width: 360px) {
            .mobile-resources {
                font-size: 0.8rem;
                gap: 8px;
            }
            
            .resource-item {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .mobile-buildings-grid {
                gap: 8px;
                padding: 12px;
            }
            
            .building-icon-mobile {
                font-size: 1.5rem;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .mobile-header {
                padding: 8px 16px;
                min-height: 40px;
            }
            
            .mobile-action-bar {
                padding: 8px 16px;
            }
            
            .mobile-action-btn {
                min-height: 40px;
                padding: 6px 4px;
            }
        }

        /* Mode sombre optimisé pour OLED */
        @media (prefers-color-scheme: dark) {
            :root {
                --dark-bg: #000000;
                --dark-stone: #0a0a0a;
            }
        }

        /* Animation de chargement */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-gold);
            border-top: 4px solid var(--gold-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            text-align: center;
            color: var(--gold-light);
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Bouton hambourger pour menu */
        .hamburger-menu {
            position: fixed;
            top: max(env(safe-area-inset-top), 12px);
            left: 16px;
            z-index: 101;
            background: rgba(217, 119, 6, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: var(--mobile-touch-size);
            height: var(--mobile-touch-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .hamburger-menu:active {
            transform: scale(0.95);
            background: var(--gold-primary);
        }

        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .hamburger-line {
            width: 18px;
            height: 2px;
            background: white;
            border-radius: 1px;
            transition: all 0.2s ease;
        }

        /* Menu latéral */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-right: 2px solid var(--gold-primary);
            z-index: 1001;
            transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            padding-top: max(env(safe-area-inset-top), 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .side-menu.open {
            left: 0;
        }

        .side-menu-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-gold);
            text-align: center;
        }

        .side-menu-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--gold-primary);
            margin-bottom: 8px;
        }

        .side-menu-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .side-menu-items {
            padding: 16px;
        }

        .side-menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid var(--border-gold);
            border-radius: var(--mobile-border-radius);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--mobile-touch-size);
            touch-action: manipulation;
        }

        .side-menu-item:active {
            background: rgba(217, 119, 6, 0.1);
            border-color: var(--gold-primary);
            transform: scale(0.98);
        }

        .side-menu-item .icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }

        .side-menu-item .text {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Écran de chargement -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">IMPERIUM</div>
        <div class="loading-subtext">Chargement de votre empire...</div>
    </div>

    <!-- Interface mobile principale -->
    <div id="mobileGameContainer" class="mobile-game-container" style="display: none;">
        <!-- Header mobile -->
        <header class="mobile-header">
            <div class="mobile-logo">IMPERIUM</div>
            <div class="mobile-resources" id="mobileResources">
                <div class="resource-item">
                    <span>💰</span>
                    <span id="goldMobile">1000</span>
                </div>
                <div class="resource-item">
                    <span>🌾</span>
                    <span id="foodMobile">500</span>
                </div>
                <div class="resource-item">
                    <span>🏛️</span>
                    <span id="stoneMobile">300</span>
                </div>
            </div>
        </header>

        <!-- Zone de jeu principale -->
        <main class="mobile-game-area">
            <div class="mobile-buildings-grid" id="mobileBuildingsGrid">
                <!-- Les bâtiments seront générés dynamiquement -->
            </div>
        </main>

        <!-- Barre d'actions mobile -->
        <nav class="mobile-action-bar">
            <button class="mobile-action-btn" onclick="mobileGame.showBuildMenu()">
                <div class="icon">🔨</div>
                <div>Construire</div>
            </button>
            <button class="mobile-action-btn" onclick="mobileGame.showWorldMap()">
                <div class="icon">🗺️</div>
                <div>Monde</div>
            </button>
            <button class="mobile-action-btn" onclick="mobileGame.showMilitary()">
                <div class="icon">⚔️</div>
                <div>Armée</div>
            </button>
            <button class="mobile-action-btn" onclick="mobileGame.showTrade()">
                <div class="icon">🚛</div>
                <div>Commerce</div>
            </button>
            <button class="mobile-action-btn" onclick="mobileGame.showSettings()">
                <div class="icon">⚙️</div>
                <div>Menu</div>
            </button>
        </nav>
    </div>

    <!-- Menu contextuel mobile -->
    <div id="mobileContextMenu" class="mobile-context-menu hidden">
        <div class="context-menu-header">
            <div class="context-menu-title" id="contextMenuTitle">Options</div>
            <button class="context-menu-close" onclick="mobileGame.hideContextMenu()">×</button>
        </div>
        <div class="context-menu-options" id="contextMenuOptions">
            <!-- Les options seront générées dynamiquement -->
        </div>
    </div>

    <!-- Menu latéral -->
    <nav id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-title">IMPERIUM</div>
            <div class="side-menu-subtitle">Roma Aeterna</div>
        </div>
        <div class="side-menu-items">
            <div class="side-menu-item" onclick="mobileGame.showProfile()">
                <div class="icon">👤</div>
                <div class="text">Profil</div>
            </div>
            <div class="side-menu-item" onclick="mobileGame.showTechnology()">
                <div class="icon">🔬</div>
                <div class="text">Recherche</div>
            </div>
            <div class="side-menu-item" onclick="mobileGame.showDiplomacy()">
                <div class="icon">🤝</div>
                <div class="text">Diplomatie</div>
            </div>
            <div class="side-menu-item" onclick="mobileGame.showStatistics()">
                <div class="icon">📊</div>
                <div class="text">Statistiques</div>
            </div>
            <div class="side-menu-item" onclick="mobileGame.showHelp()">
                <div class="icon">❓</div>
                <div class="text">Aide</div>
            </div>
            <div class="side-menu-item" onclick="mobileGame.showSettings()">
                <div class="icon">⚙️</div>
                <div class="text">Paramètres</div>
            </div>
        </div>
    </nav>

    <!-- Bouton menu hamburger -->
    <button class="hamburger-menu" onclick="mobileGame.toggleSideMenu()">
        <div class="hamburger-icon">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </div>
    </button>

    <!-- Overlay pour fermer les menus -->
    <div id="mobileOverlay" class="mobile-overlay hidden" onclick="mobileGame.hideAllMenus()"></div>

    <!-- Système de notifications mobile -->
    <div id="mobileNotifications" class="mobile-notifications"></div>

    <!-- Contrôleur mobile -->
    <script>
        class MobileGameController {
            constructor() {
                this.isInitialized = false;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.touchEndX = 0;
                this.touchEndY = 0;
                this.currentView = 'city';
                this.sideMenuOpen = false;
            }

            async initialize() {
                if (this.isInitialized) return;

                console.log('📱 IMPERIUM Mobile - Initializing...');

                try {
                    // Attendre que les systèmes de base soient chargés
                    await this.waitForBaseSystems();

                    // Initialiser l'état du jeu
                    await this.initializeGameState();

                    // Configurer l'interface mobile
                    this.setupMobileInterface();

                    // Configurer les événements tactiles
                    this.setupTouchEvents();

                    // Démarrer les systèmes
                    this.startMobileSystems();

                    // Marquer comme initialisé
                    this.isInitialized = true;

                    // Masquer le chargement et afficher le jeu
                    this.showGame();

                    console.log('✅ Mobile Game initialized successfully');

                } catch (error) {
                    console.error('❌ Failed to initialize mobile game:', error);
                    this.showError('Erreur de chargement');
                }
            }

            async waitForBaseSystems() {
                return new Promise((resolve) => {
                    const checkSystems = () => {
                        if (typeof gameState !== 'undefined' && 
                            typeof BUILDING_DEFINITIONS !== 'undefined') {
                            resolve();
                        } else {
                            setTimeout(checkSystems, 100);
                        }
                    };
                    checkSystems();
                });
            }

            async initializeGameState() {
                if (typeof gameState === 'undefined') {
                    // Initialiser un état de jeu basique pour mobile
                    window.gameState = {
                        player: {
                            name: "Empereur",
                            level: 1,
                            experience: 0,
                            experienceToNext: 1000
                        },
                        resources: {
                            gold: 1000,
                            food: 500,
                            stone: 300,
                            wood: 200,
                            iron: 100
                        },
                        city: {
                            name: "Roma",
                            population: 1000,
                            happiness: 75,
                            buildings: this.generateInitialBuildings()
                        }
                    };
                }

                // Charger l'état sauvegardé si disponible
                const savedState = localStorage.getItem('imperium_mobile_save');
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        Object.assign(gameState, parsed);
                    } catch (e) {
                        console.warn('Invalid save data, using default state');
                    }
                }
            }

            generateInitialBuildings() {
                const buildings = [];
                const gridSize = 12; // 3x4 ou 4x4 selon l'écran

                for (let i = 0; i < gridSize; i++) {
                    buildings.push({
                        slotId: i,
                        type: i < 3 ? ['house', 'farm', 'quarry'][i] : null,
                        level: i < 3 ? 1 : 0,
                        isConstructing: false,
                        constructionStartTime: null,
                        constructionDuration: 0
                    });
                }

                return buildings;
            }

            setupMobileInterface() {
                this.updateResources();
                this.renderBuildingsGrid();
                this.setupPeriodicUpdates();
            }

            setupTouchEvents() {
                // Gestes de balayage pour navigation
                document.addEventListener('touchstart', (e) => {
                    this.touchStartX = e.touches[0].clientX;
                    this.touchStartY = e.touches[0].clientY;
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    this.touchEndX = e.changedTouches[0].clientX;
                    this.touchEndY = e.changedTouches[0].clientY;
                    this.handleSwipeGesture();
                }, { passive: true });

                // Empêcher le zoom par pincement sur certains éléments
                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                // Haptic feedback pour les appareils supportés
                this.setupHapticFeedback();
            }

            handleSwipeGesture() {
                const deltaX = this.touchEndX - this.touchStartX;
                const deltaY = this.touchEndY - this.touchStartY;
                const minSwipeDistance = 100;

                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe droite - ouvrir menu latéral
                        this.openSideMenu();
                    } else {
                        // Swipe gauche - fermer menu latéral
                        this.closeSideMenu();
                    }
                }
            }

            setupHapticFeedback() {
                if ('vibrate' in navigator) {
                    this.hapticEnabled = true;
                }
            }

            triggerHaptic(type = 'light') {
                if (!this.hapticEnabled) return;

                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30],
                    success: [10, 50, 10],
                    error: [100, 50, 100]
                };

                navigator.vibrate(patterns[type] || patterns.light);
            }

            startMobileSystems() {
                // Système de sauvegarde automatique
                this.saveInterval = setInterval(() => {
                    this.autoSave();
                }, 30000); // Sauvegarde toutes les 30 secondes

                // Système de mise à jour des ressources
                this.updateInterval = setInterval(() => {
                    this.updateResources();
                    this.updateBuildings();
                }, 1000);
            }

            showGame() {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mobileGameContainer').style.display = 'flex';
                this.showNotification('Bienvenue dans IMPERIUM !', 'success');
            }

            showError(message) {
                const loading = document.getElementById('loadingOverlay');
                loading.innerHTML = `
                    <div style="color: var(--error-red); text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">⚠️</div>
                        <div class="loading-text">Erreur</div>
                        <div class="loading-subtext">${message}</div>
                        <button onclick="location.reload()" style="
                            margin-top: 20px;
                            padding: 12px 24px;
                            background: var(--gold-primary);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            font-weight: bold;
                            cursor: pointer;
                        ">Recharger</button>
                    </div>
                `;
            }

            updateResources() {
                if (!gameState?.resources) return;

                document.getElementById('goldMobile').textContent = this.formatNumber(gameState.resources.gold);
                document.getElementById('foodMobile').textContent = this.formatNumber(gameState.resources.food);
                document.getElementById('stoneMobile').textContent = this.formatNumber(gameState.resources.stone);
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
                return num.toString();
            }

            renderBuildingsGrid() {
                const grid = document.getElementById('mobileBuildingsGrid');
                if (!grid || !gameState?.city?.buildings) return;

                grid.innerHTML = '';

                gameState.city.buildings.forEach((building, index) => {
                    const slot = document.createElement('div');
                    slot.className = `mobile-building-slot ${building.type ? 'occupied' : ''}`;
                    slot.dataset.slotId = building.slotId || index;

                    if (building.type && BUILDING_DEFINITIONS[building.type]) {
                        const def = BUILDING_DEFINITIONS[building.type];
                        slot.innerHTML = `
                            <div class="building-icon-mobile">${def.icon}</div>
                            <div class="building-name-mobile">${def.name}</div>
                            ${building.level > 1 ? `<div class="building-level-mobile">${building.level}</div>` : ''}
                            ${building.isConstructing ? `
                                <div class="construction-progress-mobile">
                                    <div class="progress-bar-mobile" style="width: ${this.getConstructionProgress(building)}%"></div>
                                </div>
                            ` : ''}
                        `;
                    } else {
                        slot.innerHTML = `
                            <div class="building-icon-mobile">🏗️</div>
                            <div class="building-name-mobile">Terrain Libre</div>
                        `;
                    }

                    slot.onclick = () => this.handleBuildingTap(building, index);
                    grid.appendChild(slot);
                });
            }

            getConstructionProgress(building) {
                if (!building.isConstructing || !building.constructionStartTime) return 0;
                
                const elapsed = Date.now() - building.constructionStartTime;
                const progress = Math.min((elapsed / building.constructionDuration) * 100, 100);
                return Math.round(progress);
            }

            handleBuildingTap(building, slotIndex) {
                this.triggerHaptic('light');

                if (building.type) {
                    this.showBuildingOptions(building, slotIndex);
                } else {
                    this.showBuildMenu(slotIndex);
                }
            }

            showBuildingOptions(building, slotIndex) {
                const def = BUILDING_DEFINITIONS[building.type];
                const options = [
                    {
                        icon: '📊',
                        title: 'Informations',
                        description: `Niveau ${building.level} - ${def.description}`,
                        action: () => this.showBuildingDetails(building)
                    },
                    {
                        icon: '⬆️',
                        title: 'Améliorer',
                        description: `Coût: ${this.getUpgradeCost(building)} or`,
                        action: () => this.upgradeBuilding(building, slotIndex)
                    },
                    {
                        icon: '🔄',
                        title: 'Collecter',
                        description: 'Récupérer la production',
                        action: () => this.collectProduction(building, slotIndex)
                    },
                    {
                        icon: '🗑️',
                        title: 'Démolir',
                        description: 'Détruire ce bâtiment',
                        action: () => this.demolishBuilding(building, slotIndex)
                    }
                ];

                this.showContextMenu(`${def.name} (Niv. ${building.level})`, options);
            }

            showBuildMenu(slotIndex) {
                const buildableBuildings = Object.keys(BUILDING_DEFINITIONS).slice(0, 6); // Limiter pour mobile
                const options = buildableBuildings.map(type => {
                    const def = BUILDING_DEFINITIONS[type];
                    return {
                        icon: def.icon,
                        title: def.name,
                        description: `Coût: ${def.cost?.gold || 100} or`,
                        action: () => this.buildBuilding(type, slotIndex)
                    };
                });

                this.showContextMenu('Construire', options);
            }

            showContextMenu(title, options) {
                const menu = document.getElementById('mobileContextMenu');
                const overlay = document.getElementById('mobileOverlay');
                const titleEl = document.getElementById('contextMenuTitle');
                const optionsEl = document.getElementById('contextMenuOptions');

                titleEl.textContent = title;
                optionsEl.innerHTML = '';

                options.forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'context-menu-option';
                    optionEl.innerHTML = `
                        <div class="icon">${option.icon}</div>
                        <div class="content">
                            <div class="title">${option.title}</div>
                            <div class="description">${option.description}</div>
                        </div>
                    `;
                    optionEl.onclick = () => {
                        this.triggerHaptic('medium');
                        this.hideContextMenu();
                        option.action();
                    };
                    optionsEl.appendChild(optionEl);
                });

                menu.classList.remove('hidden');
                overlay.classList.remove('hidden');
                this.triggerHaptic('light');
            }

            hideContextMenu() {
                document.getElementById('mobileContextMenu').classList.add('hidden');
                document.getElementById('mobileOverlay').classList.add('hidden');
            }

            hideAllMenus() {
                this.hideContextMenu();
                this.closeSideMenu();
            }

            toggleSideMenu() {
                if (this.sideMenuOpen) {
                    this.closeSideMenu();
                } else {
                    this.openSideMenu();
                }
            }

            openSideMenu() {
                document.getElementById('sideMenu').classList.add('open');
                document.getElementById('mobileOverlay').classList.remove('hidden');
                this.sideMenuOpen = true;
                this.triggerHaptic('light');
            }

            closeSideMenu() {
                document.getElementById('sideMenu').classList.remove('open');
                document.getElementById('mobileOverlay').classList.add('hidden');
                this.sideMenuOpen = false;
            }

            buildBuilding(type, slotIndex) {
                const def = BUILDING_DEFINITIONS[type];
                const cost = def.cost?.gold || 100;

                if (gameState.resources.gold < cost) {
                    this.showNotification('Pas assez d\'or !', 'error');
                    return;
                }

                gameState.resources.gold -= cost;
                gameState.city.buildings[slotIndex].type = type;
                gameState.city.buildings[slotIndex].level = 1;
                gameState.city.buildings[slotIndex].isConstructing = true;
                gameState.city.buildings[slotIndex].constructionStartTime = Date.now();
                gameState.city.buildings[slotIndex].constructionDuration = def.constructionTime || 30000;

                this.renderBuildingsGrid();
                this.updateResources();
                this.showNotification(`${def.name} en construction !`, 'success');
                this.triggerHaptic('success');
            }

            upgradeBuilding(building, slotIndex) {
                const cost = this.getUpgradeCost(building);
                
                if (gameState.resources.gold < cost) {
                    this.showNotification('Pas assez d\'or !', 'error');
                    return;
                }

                gameState.resources.gold -= cost;
                building.level += 1;
                building.isConstructing = true;
                building.constructionStartTime = Date.now();
                building.constructionDuration = 20000 * building.level;

                this.renderBuildingsGrid();
                this.updateResources();
                this.showNotification(`Amélioration en cours !`, 'success');
                this.triggerHaptic('success');
            }

            collectProduction(building, slotIndex) {
                const def = BUILDING_DEFINITIONS[building.type];
                if (!def.production) return;

                const baseProduction = def.production.gold || 0;
                const production = Math.floor(baseProduction * building.level * 0.5); // Production réduite pour mobile

                gameState.resources.gold += production;
                this.updateResources();
                this.showNotification(`+${production} or collecté !`, 'success');
                this.triggerHaptic('light');
            }

            demolishBuilding(building, slotIndex) {
                if (confirm('Êtes-vous sûr de vouloir démolir ce bâtiment ?')) {
                    gameState.city.buildings[slotIndex] = {
                        slotId: slotIndex,
                        type: null,
                        level: 0,
                        isConstructing: false
                    };

                    this.renderBuildingsGrid();
                    this.showNotification('Bâtiment démoli !', 'success');
                    this.triggerHaptic('heavy');
                }
            }

            getUpgradeCost(building) {
                return Math.floor(100 * Math.pow(1.5, building.level));
            }

            updateBuildings() {
                if (!gameState?.city?.buildings) return;

                let hasChanges = false;
                gameState.city.buildings.forEach((building, index) => {
                    if (building.isConstructing && building.constructionStartTime) {
                        const elapsed = Date.now() - building.constructionStartTime;
                        if (elapsed >= building.constructionDuration) {
                            building.isConstructing = false;
                            building.constructionStartTime = null;
                            building.constructionDuration = 0;
                            hasChanges = true;
                            
                            const def = BUILDING_DEFINITIONS[building.type];
                            this.showNotification(`${def.name} terminé !`, 'success');
                            this.triggerHaptic('success');
                        }
                    }
                });

                if (hasChanges) {
                    this.renderBuildingsGrid();
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('mobileNotifications');
                const notification = document.createElement('div');
                notification.className = `mobile-notification ${type}`;
                notification.textContent = message;

                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            setupPeriodicUpdates() {
                // Génération passive de ressources
                setInterval(() => {
                    if (gameState?.city?.buildings) {
                        gameState.city.buildings.forEach(building => {
                            if (building.type && !building.isConstructing) {
                                const def = BUILDING_DEFINITIONS[building.type];
                                if (def?.production?.gold) {
                                    const production = Math.floor(def.production.gold * building.level * 0.1);
                                    gameState.resources.gold += production;
                                }
                            }
                        });
                        this.updateResources();
                    }
                }, 5000);
            }

            autoSave() {
                try {
                    localStorage.setItem('imperium_mobile_save', JSON.stringify(gameState));
                } catch (e) {
                    console.warn('Failed to save game state:', e);
                }
            }

            // Méthodes pour les actions du menu
            showWorldMap() {
                this.showNotification('Carte du monde en développement', 'info');
            }

            showMilitary() {
                this.showNotification('Système militaire en développement', 'info');
            }

            showTrade() {
                this.showNotification('Système de commerce en développement', 'info');
            }

            showProfile() {
                this.showNotification('Profil joueur en développement', 'info');
            }

            showTechnology() {
                this.showNotification('Arbre technologique en développement', 'info');
            }

            showDiplomacy() {
                this.showNotification('Diplomatie en développement', 'info');
            }

            showStatistics() {
                this.showNotification('Statistiques en développement', 'info');
            }

            showHelp() {
                this.showNotification('Aide en développement', 'info');
            }

            showSettings() {
                const options = [
                    {
                        icon: '🔊',
                        title: 'Audio',
                        description: 'Activer/désactiver les sons',
                        action: () => this.toggleAudio()
                    },
                    {
                        icon: '📳',
                        title: 'Vibrations',
                        description: 'Activer/désactiver les vibrations',
                        action: () => this.toggleVibration()
                    },
                    {
                        icon: '🌙',
                        title: 'Mode sombre',
                        description: 'Basculer le thème',
                        action: () => this.toggleTheme()
                    },
                    {
                        icon: '💾',
                        title: 'Sauvegarder',
                        description: 'Forcer la sauvegarde',
                        action: () => this.forceSave()
                    },
                    {
                        icon: '🔄',
                        title: 'Recharger',
                        description: 'Recharger le jeu',
                        action: () => location.reload()
                    }
                ];

                this.showContextMenu('Paramètres', options);
            }

            toggleAudio() {
                this.showNotification('Paramètres audio en développement', 'info');
            }

            toggleVibration() {
                this.hapticEnabled = !this.hapticEnabled;
                this.showNotification(`Vibrations ${this.hapticEnabled ? 'activées' : 'désactivées'}`, 'success');
            }

            toggleTheme() {
                document.body.classList.toggle('dark-theme');
                this.showNotification('Thème modifié', 'success');
            }

            forceSave() {
                this.autoSave();
                this.showNotification('Jeu sauvegardé !', 'success');
                this.triggerHaptic('success');
            }

            // Nouvelles méthodes pour les gestes avancés
            quickUpgrade(building, slotIndex) {
                const cost = this.getUpgradeCost(building);
                
                if (gameState.resources.gold < cost) {
                    this.showNotification('Pas assez d\'or pour l\'amélioration !', 'error');
                    this.triggerHaptic('error');
                    return;
                }

                this.upgradeBuilding(building, slotIndex);
            }

            showInstallPrompt(deferredPrompt) {
                if (!deferredPrompt) return;

                const options = [
                    {
                        icon: '📲',
                        title: 'Installer l\'application',
                        description: 'Ajoutez IMPERIUM à votre écran d\'accueil pour un accès rapide',
                        action: () => {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('User accepted the install prompt');
                                    this.showNotification('Installation en cours...', 'success');
                                } else {
                                    console.log('User dismissed the install prompt');
                                }
                            });
                        }
                    },
                    {
                        icon: '❌',
                        title: 'Plus tard',
                        description: 'Continuer dans le navigateur',
                        action: () => {
                            this.hideContextMenu();
                        }
                    }
                ];

                this.showContextMenu('Installer IMPERIUM', options);
            }

            // Méthodes pour la gestion des performances
            checkPerformance() {
                // Surveiller les performances et afficher des avertissements si nécessaire
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => {
                        const memory = performance.memory;
                        if (memory && memory.usedJSHeapSize > 50 * 1024 * 1024) { // 50MB
                            this.showPerformanceWarning('Utilisation mémoire élevée');
                        }
                    });
                }
            }

            showPerformanceWarning(message) {
                const warning = document.createElement('div');
                warning.className = 'performance-warning show';
                warning.textContent = `⚠️ ${message}`;
                document.body.appendChild(warning);

                setTimeout(() => {
                    warning.classList.remove('show');
                    setTimeout(() => {
                        if (warning.parentNode) {
                            warning.parentNode.removeChild(warning);
                        }
                    }, 300);
                }, 3000);
            }

            // Optimisation des animations selon les performances
            adaptAnimationsToPerformance() {
                if ('deviceMemory' in navigator && navigator.deviceMemory < 4) {
                    // Réduire les animations sur les appareils avec peu de mémoire
                    document.documentElement.style.setProperty('--mobile-border-radius', '8px');
                    this.showNotification('Mode performance activé', 'info');
                }
            }

            // Gestion des interruptions (appels, notifications, etc.)
            handleInterruption() {
                if (document.hidden) {
                    // Mettre en pause ou ralentir le jeu
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                        this.updateInterval = null;
                    }
                } else {
                    // Reprendre le jeu
                    if (!this.updateInterval) {
                        this.startMobileSystems();
                    }
                }
            }

            // Méthode pour diagnostiquer les problèmes
            runDiagnostics() {
                const diagnostics = {
                    serviceWorker: 'serviceWorker' in navigator,
                    localStorage: this.testLocalStorage(),
                    vibration: 'vibrate' in navigator,
                    touchSupport: 'ontouchstart' in window,
                    screenSize: `${window.screen.width}x${window.screen.height}`,
                    pixelRatio: window.devicePixelRatio,
                    userAgent: navigator.userAgent,
                    memory: performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB' : 'N/A'
                };

                console.log('📊 IMPERIUM Mobile Diagnostics:', diagnostics);
                return diagnostics;
            }

            testLocalStorage() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Méthode pour exporter/importer les sauvegardes
            exportSave() {
                try {
                    const saveData = {
                        gameState: gameState,
                        timestamp: Date.now(),
                        version: '2.0.0'
                    };

                    const dataStr = JSON.stringify(saveData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `imperium-save-${new Date().toISOString().slice(0,10)}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    this.showNotification('Sauvegarde exportée !', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showNotification('Erreur lors de l\'export', 'error');
                }
            }

            importSave(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        
                        if (saveData.gameState && saveData.version) {
                            gameState = saveData.gameState;
                            localStorage.setItem('imperium_mobile_save', JSON.stringify(gameState));
                            
                            this.updateResources();
                            this.renderBuildingsGrid();
                            
                            this.showNotification('Sauvegarde importée !', 'success');
                        } else {
                            throw new Error('Format de sauvegarde invalide');
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        this.showNotification('Erreur lors de l\'import', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Instance globale du contrôleur mobile
        const mobileGame = new MobileGameController();

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            mobileGame.initialize();
            
            // Enregistrer le service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('✅ Service Worker registered successfully:', registration);
                        
                        // Vérifier les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Une nouvelle version est disponible
                                    mobileGame.showNotification('Mise à jour disponible ! Rechargez l\'app.', 'info');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('❌ Service Worker registration failed:', error);
                    });
            }
        });

        // Nettoyage lors de la fermeture
        window.addEventListener('beforeunload', () => {
            mobileGame.autoSave();
        });

        // Gestion de la mise en arrière-plan/premier plan (Page Visibility API)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                mobileGame.autoSave();
            }
        });
        
        // Gestion des gestes avancés
        let startX, startY, startTime;
        
        document.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startTime = Date.now();
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const endTime = Date.now();
            
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            const deltaTime = endTime - startTime;
            
            // Détection de tap rapide (double tap)
            if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10 && deltaTime < 200) {
                if (window.lastTapTime && (startTime - window.lastTapTime) < 500) {
                    // Double tap détecté
                    const target = e.target.closest('.mobile-building-slot');
                    if (target && mobileGame.isInitialized) {
                        mobileGame.triggerHaptic('medium');
                        // Action de double tap (ex: amélioration rapide)
                        const slotId = target.dataset.slotId;
                        if (slotId && gameState?.city?.buildings[slotId]?.type) {
                            mobileGame.quickUpgrade(gameState.city.buildings[slotId], slotId);
                        }
                    }
                }
                window.lastTapTime = startTime;
            }
        }, { passive: true });
        
        // Amélioration de l'expérience utilisateur
        window.addEventListener('online', () => {
            mobileGame.showNotification('Connexion rétablie !', 'success');
        });
        
        window.addEventListener('offline', () => {
            mobileGame.showNotification('Mode hors ligne activé', 'info');
        });
        
        // Gestion de l'installation PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Afficher le bouton d'installation après un délai
            setTimeout(() => {
                mobileGame.showInstallPrompt(deferredPrompt);
            }, 10000);
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('📱 PWA installed successfully');
            mobileGame.showNotification('App installée avec succès !', 'success');
            deferredPrompt = null;
        });
    </script>
</body>
</html>