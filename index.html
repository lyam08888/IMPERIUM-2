<!DOCTYPE html>
<html lang="fr" data-theme="default">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>IMPERIUM ‚Äî Mobile v3 (Single File)</title>
<meta name="theme-color" content="#0b0f1a">
<style>
/* ============ THEMES ============ */
:root{
  --bg:#0b0f1a; --panel:#0f1426; --panel-2:#0a1020;
  --accent:#d2b35b; --accent-2:#8c6e2a;
  --text:#f2efe6; --muted:#aab0bd; --line:#273251;
  --ok:#77d39c; --warn:#ffb454; --bad:#ff7b7b;
  --touch:56px; --radius:14px; --shadow:0 12px 32px rgba(0,0,0,.35);
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-t: env(safe-area-inset-top, 0px);
}
html[data-theme="sepia"]{
  --bg:#1a150f; --panel:#221a12; --panel-2:#1a130e;
  --accent:#d1a562; --accent-2:#8a6a2b; --text:#f1e6cf; --muted:#b8a98f; --line:#3a2c1b;
}
html[data-theme="ivory"]{
  --bg:#0f1115; --panel:#141820; --panel-2:#0f141c;
  --accent:#cfd8dc; --accent-2:#90a4ae; --text:#f5f7fa; --muted:#c3c8cf; --line:#2a3446;
}
html[data-theme="contrast"]{
  --bg:#000; --panel:#0a0a0a; --panel-2:#000; --accent:#ffd95a; --accent-2:#e6b800;
  --text:#fff; --muted:#bbb; --line:#222;
}

/* ============ RESET & BASE ============ */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;}
@media (prefers-reduced-motion:no-preference){ .t {transition: all .25s ease;} }
.hidden{display:none!important}

/* ============ LAYOUT ============ */
#app{display:flex;flex-direction:column;height:100%;}
header{
  position:sticky;top:0;padding:10px 16px calc(8px + var(--safe-t));
  background:linear-gradient(180deg,#121a31 0%,#0b1022 100%);
  display:flex;align-items:center;gap:12px;z-index:4;border-bottom:1px solid var(--line);
}
h1{font-size:18px;margin:0;letter-spacing:.3px;color:var(--accent);}
.header-actions{margin-left:auto;display:flex;gap:8px;}
.btn{
  background:#141c34;border:1px solid var(--line);color:var(--text);
  border-radius:12px;min-height:40px;padding:8px 12px;font-size:14px;
}
.btn:active{transform:scale(.98)}
.res-wrap{display:flex;gap:8px;overflow:auto;padding:6px 12px;scroll-snap-type:x mandatory;border-bottom:1px solid var(--line)}
.res-chip{flex:0 0 auto;display:flex;align-items:center;gap:6px;background:rgba(20,28,52,.85);border:1px solid var(--line);border-radius:999px;padding:8px 10px;font-size:13px;scroll-snap-align:center;}

#game-wrap{position:relative;flex:1;overflow:hidden;}
canvas{width:100%;height:100%;display:block;touch-action:none;}

/* FAB */
.fab{position:absolute;right:16px;bottom:calc(88px + var(--safe-b));width:64px;height:64px;border-radius:999px;border:1px solid var(--line);
  background:radial-gradient(circle at 30% 30%, #2a3558, #11182e);color:var(--text);font-size:28px;display:grid;place-items:center;box-shadow:var(--shadow);z-index:3;}
.fab:active{transform:scale(.97)}

/* Dock */
#dock{position:sticky;bottom:0;z-index:5;padding:8px 10px calc(8px + var(--safe-b));
  background:linear-gradient(0deg,rgba(11,16,34,1) 0%, rgba(11,16,34,.9) 60%, rgba(11,16,34,0) 100%);}
.dock{display:flex;gap:6px;background:rgba(20,28,52,.92);border:1px solid var(--line);border-radius:16px;padding:6px;justify-content:space-between;align-items:center;}
.dock .i{flex:1 1 0;min-width:56px;min-height:var(--touch);display:flex;gap:6px;flex-direction:column;align-items:center;justify-content:center;color:#d7dbe6;border-radius:12px;}
.dock .i.active{background:#141c34;box-shadow:inset 0 0 0 1px var(--line);color:var(--accent);}
.dock .i .ico{font-size:20px;}

/* Bottom Sheet */
.sheet{position:absolute;left:0;right:0;bottom:0;transform:translateY(105%);background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
  border-top-left-radius:20px;border-top-right-radius:20px;border:1px solid var(--line);border-bottom:none;box-shadow:var(--shadow);z-index:6;max-height:75%;
  display:flex;flex-direction:column;}
.sheet.show{transform:translateY(0%);}
.sheet header{padding:10px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;}
.sheet h2{margin:0;font-size:16px;color:var(--accent);}
.sheet .grab{width:42px;height:5px;border-radius:999px;background:#2a3558;margin:6px auto;}
.sheet .body{padding:12px 16px;overflow:auto;display:grid;gap:10px;}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.tag{border:1px solid var(--line);border-radius:10px;padding:2px 8px;font-size:12px;color:#d7dbe6;}
.small{font-size:12px;color:var(--muted);}
.card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#141c34;display:grid;gap:8px;}

/* Builder Ghost */
.ghost-tip{position:absolute;pointer-events:none;padding:6px 8px;border-radius:8px;background:rgba(20,28,52,.9);border:1px solid var(--line);font-size:12px;color:var(--text);z-index:7;transform:translate(-50%,-140%);}

/* Toast */
.toast{position:absolute;left:50%;bottom:calc(120px + var(--safe-b));transform:translateX(-50%);
  background:rgba(20,28,52,.96);border:1px solid var(--line);padding:10px 12px;border-radius:12px;font-size:13px;z-index:8;box-shadow:var(--shadow);}

/* Onboarding */
#ob{position:absolute;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:9;}
#ob.show{display:flex;}
.ob-sheet{width:100%;max-width:640px;background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);border-top-left-radius:16px;border-top-right-radius:16px;
  border:1px solid var(--line);box-shadow:var(--shadow);padding:14px;display:grid;gap:10px;}
.ob-title{font-size:16px;color:var(--accent);margin:0;}
.ob-actions{display:flex;gap:8px;justify-content:flex-end;}
.kbd{padding:2px 6px;border-radius:4px;border:1px solid var(--line);background:#1a2238;font-size:12px}

/* Anim helpers */
@keyframes pop { 0%{transform:scale(.6);opacity:.0} 70%{transform:scale(1.05);opacity:1} 100%{transform:scale(1);} }
.pop{animation:pop .25s ease-out;}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>IMPERIUM</h1>
    <div class="header-actions">
      <button id="btn-save" class="btn" title="Sauvegarder">üíæ</button>
      <button id="btn-load" class="btn" title="Charger">üìÇ</button>
      <button id="btn-reset" class="btn" title="R√©init">‚ôªÔ∏è</button>
      <button id="btn-settings" class="btn" title="R√©glages">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="res-wrap" id="resbar"></div>

  <div id="game-wrap">
    <canvas id="game" width="720" height="1280"></canvas>
    <button class="fab t" id="fab">üèóÔ∏è</button>

    <!-- Ghost tooltip -->
    <div id="ghost-tip" class="ghost-tip hidden">Tap pour confirmer</div>

    <!-- Bottom Sheet -->
    <section id="sheet" class="sheet t" aria-hidden="true">
      <div class="grab"></div>
      <header><h2 id="sheet-title">Panneau</h2></header>
      <div id="sheet-body" class="body"></div>
    </section>

    <!-- Onboarding -->
    <section id="ob">
      <div class="ob-sheet">
        <h3 class="ob-title" id="ob-title">Bienvenue dans Imperium</h3>
        <div id="ob-body" class="small"></div>
        <div class="ob-actions">
          <button class="btn" id="ob-skip">Passer</button>
          <button class="btn" id="ob-next">Suivant</button>
        </div>
      </div>
    </section>
  </div>

  <div id="dock">
    <nav class="dock">
      <button class="i active" data-tab="city"><span class="ico">üèõÔ∏è</span><span class="small">Ville</span></button>
      <button class="i" data-tab="build"><span class="ico">üß±</span><span class="small">Construire</span></button>
      <button class="i" data-tab="research"><span class="ico">üß™</span><span class="small">Recherches</span></button>
      <button class="i" data-tab="army"><span class="ico">üõ°Ô∏è</span><span class="small">Arm√©e</span></button>
      <button class="i" data-tab="world"><span class="ico">üó∫Ô∏è</span><span class="small">Monde</span></button>
      <button class="i" data-tab="diplo"><span class="ico">ü§ù</span><span class="small">Diplomatie</span></button>
      <button class="i" data-tab="menu"><span class="ico">‚ò∞</span><span class="small">Menu</span></button>
    </nav>
  </div>
</div>

<script>
(() => {
/* ================= CORE STATE ================= */
const S = {
  time:{dt:0,last:performance.now(),speed:1},
  cam:{x:0,y:0,zoom:2},
  input:{touches:new Map(),pinch:0,mode:'select',longPress:null},
  grid:{w:60,h:60,ts:32},
  city:{buildings:[], queue:null, research:{}, army:{legion:0}},
  res:{
    bois:150,pierre:120,argile:120,fer:50,or:30,vin:10,science:0,
    pop:8, logements:20, bonheur:100,
    storage: { bois:500, pierre:500, argile:500, fer:300, or:300, vin:300 }
  },
  rates:{bois:1.0,pierre:0.8,argile:0.8,fer:0.2,or:0.1,vin:0,science:0.2,pop:0},
  ui:{tab:'city', oneHand:'right', theme:(localStorage.getItem('imperium-theme')||'default'), sound:true},
  fx:[] // animations [{x,y,t,kind}]
};
document.documentElement.setAttribute('data-theme', S.ui.theme);

/* ================= AUDIO (WebAudio tiny beeps) ================= */
let AC=null;
function audioCtx(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); return AC;}
function beep(freq=440, dur=0.06, type='sine', vol=0.05){
  if(!S.ui.sound) return;
  const ctx=audioCtx();
  const o=ctx.createOscillator(); const g=ctx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+dur);
}
const haptics=(ms=10)=>{ if(navigator.vibrate) navigator.vibrate(ms); };

/* ================= CANVAS ================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const resbar = document.getElementById('resbar');
const sheet = document.getElementById('sheet'), sheetBody=document.getElementById('sheet-body'), sheetTitle=document.getElementById('sheet-title');
const ghostTip=document.getElementById('ghost-tip');

/* ================= UTILS ================= */
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const fmt=(n)=>Math.floor(n).toLocaleString('fr-FR');
function rnd(a,b){ return Math.random()*(b-a)+a; }

/* ================= DEFINITIONS ================= */
const BDEF = {
  'Scierie': {cat:'prod', baseCost:{bois:40,pierre:10}, baseTime:5, rate:{bois:0.8}},
  'Carri√®re': {cat:'prod', baseCost:{bois:10,pierre:40}, baseTime:5, rate:{pierre:0.6}},
  'Briqueterie': {cat:'prod', baseCost:{bois:25,argile:35}, baseTime:6, rate:{argile:0.6}},
  'Mine de fer': {cat:'prod', baseCost:{bois:30,pierre:25,fer:10}, baseTime:8, rate:{fer:0.4}},
  'Entrep√¥t': {cat:'util', baseCost:{bois:60,pierre:40}, baseTime:6, storage:{bois:400,pierre:400,argile:400,fer:200,or:200,vin:200}},
  'Maison': {cat:'util', baseCost:{bois:35,argile:20}, baseTime:4, pop:{logements:6}},
  'Taverne': {cat:'bonheur', baseCost:{bois:50,vin:20}, baseTime:7, happy:8},
  'Thermes': {cat:'bonheur', baseCost:{pierre:80,fer:20}, baseTime:12, happy:15, needsResearch:'Hydraulique'},
  'Forum': {cat:'centre', baseCost:{bois:70,pierre:70,argile:70}, baseTime:10, rate:{or:0.1}},
  'March√©': {cat:'eco', baseCost:{bois:80,pierre:40,or:30}, baseTime:9, rate:{or:0.2}},
  'Acad√©mie': {cat:'science', baseCost:{bois:80,pierre:80}, baseTime:9, rate:{science:0.3}},
  'Temple': {cat:'culture', baseCost:{pierre:120,or:40}, baseTime:12, happy:6},
  'Caserne': {cat:'mil', baseCost:{bois:90,pierre:60,fer:40}, baseTime:10, needsResearch:'Tactiques'},
  'Port': {cat:'mil', baseCost:{bois:120,pierre:100,fer:60}, baseTime:14, needsResearch:'Navigation'},
  'S√©nat': {cat:'centre', baseCost:{pierre:150,or:60}, baseTime:15}
};
const RESEARCH = {
  'Hydraulique': { cost:{science:60}, unlocks:['Thermes'] },
  'Tactiques': { cost:{science:80}, unlocks:['Caserne'] },
  'Navigation': { cost:{science:100}, unlocks:['Port'] }
};

// World/Diplomacy bootstrap
function initWorld(){
  if(S.world) return; // already in save
  const playerFaction = 'Imperium';
  const factions = ['Gaules','Carthage','Grecques'];
  const provinces = [
    { id:'latium', name:'Latium', owner:playerFaction, yields:{or:0.1, bois:0.2}, garrison:{legion:2}, power:4 },
    { id:'etrurie', name:'√âtrurie', owner:'Gaules', yields:{pierre:0.2, or:0.08}, garrison:{legion:5}, power:7 },
    { id:'sardaigne', name:'Sardaigne', owner:'Carthage', yields:{vin:0.12, or:0.06}, garrison:{legion:6}, power:8 },
    { id:'sicile', name:'Sicile', owner:'Carthage', yields:{bois:0.15, argile:0.15}, garrison:{legion:7}, power:9 },
    { id:'macedoine', name:'Mac√©doine', owner:'Grecques', yields:{fer:0.12, or:0.09}, garrison:{legion:8}, power:10 },
    { id:'iberia', name:'Ib√©rie', owner:'Gaules', yields:{bois:0.2, argile:0.2}, garrison:{legion:6}, power:8 }
  ];
  const diplo = {};
  for(const f of factions){ diplo[f] = { relation: 20, war:false, trade:false }; }
  S.world = { playerFaction, factions, provinces, diplo };
}

// Rates composition
function getWorldRates(){
  if(!S.world) return {};
  const acc={};
  for(const p of S.world.provinces){ if(p.owner===S.world.playerFaction){ for(const [k,v] of Object.entries(p.yields)) acc[k]=(acc[k]||0)+v; } }
  return acc;
}
function getTradeRates(){
  if(!S.world) return {};
  const acc={};
  for(const [name,st] of Object.entries(S.world.diplo||{})){
    if(st.trade){ acc.or=(acc.or||0)+0.06; acc.vin=(acc.vin||0)+0.03; }
  }
  return acc;
}
function getUpkeepRates(){
  const acc={};
  const l=S.city?.army?.legion||0;
  if(l>0){ acc.or = (acc.or||0) - 0.02*l; acc.vin = (acc.vin||0) - 0.005*l; }
  return acc;
}
function mergeRates(){
  const out={};
  const parts=[S.rates||{}, getWorldRates(), getTradeRates(), getUpkeepRates()];
  for(const src of parts){ for(const [k,v] of Object.entries(src)) out[k]=(out[k]||0)+v; }
  return out;
}
function getEffectiveRates(){ return mergeRates(); }

// Combat system
function computePower(units){ return (units.legion||0) * 1.0; }
function resolveBattle(sendLegions, provinceId){
  const p=S.world.provinces.find(x=>x.id===provinceId); if(!p) return {ok:false,msg:'Province inconnue'};
  const defenderFaction=p.owner;
  if(defenderFaction!==S.world.playerFaction){
    const st=S.world.diplo[defenderFaction];
    if(st && !st.war) return {ok:false,msg:'Vous devez d√©clarer la guerre √† '+defenderFaction};
  }
  sendLegions = Math.max(0, Math.min(sendLegions, S.city.army.legion));
  if(sendLegions<=0) return {ok:false,msg:'Aucune troupe √† envoyer'};
  const atkPow = computePower({legion:sendLegions}) * (0.9 + rnd(0,0.2));
  const defPow = computePower(p.garrison) * (0.9 + rnd(0,0.2));
  if(atkPow>=defPow){
    // Victory: casualties proportional
    const lossRatio = defPow / Math.max(1, atkPow);
    const lost = Math.max(0, Math.floor(sendLegions * lossRatio * rnd(0.6,0.9)));
    S.city.army.legion -= Math.min(S.city.army.legion, lost);
    p.garrison.legion = 0;
    const prevOwner=p.owner; p.owner=S.world.playerFaction;
    // Loot: 300s worth of province yields + base gold
    let lootOr = 5;
    for(const [k,v] of Object.entries(p.yields)){
      const cap=S.res.storage[k]??Infinity;
      const add=v*300; S.res[k]=clamp((S.res[k]||0)+add,0,cap);
      if(k==='or') lootOr+=add;
    }
    S.res.or = clamp((S.res.or||0)+lootOr, 0, S.res.storage.or||Infinity);
    return {ok:true,msg:`Victoire √† ${p.name} ! Butin: ü™ô ${Math.floor(lootOr)}`};
  } else {
    // Defeat: casualties still occur
    const lost = Math.max(1, Math.floor(sendLegions * rnd(0.4,0.8)));
    S.city.army.legion -= Math.min(S.city.army.legion, lost);
    const defLoss = Math.max(0, Math.floor((p.garrison.legion||0) * rnd(0.1,0.3)));
    p.garrison.legion = Math.max(0, (p.garrison.legion||0) - defLoss);
    return {ok:false,msg:`D√©faite √† ${p.name}‚Ä¶ Pertes: ${lost}`};
  }
}

/* ================= SAVE / LOAD ================= */
const KEY='imperium-v3-single';
function save(){
  const data = JSON.stringify(S,(k,v)=>k==='touches'?undefined:v);
  localStorage.setItem(KEY,data); toast('Sauvegard√©'); haptics(8); beep(660,0.05,'square',0.04);
}
function load(){
  const d=localStorage.getItem(KEY);
  if(!d){ toast('Aucune sauvegarde'); beep(160,0.05,'sawtooth',0.05); return; }
  Object.assign(S, JSON.parse(d));
  toast('Charg√©'); haptics(8); beep(520,0.05,'triangle',0.04);
  rebuildResbar();
}
function reset(){ localStorage.removeItem(KEY); location.reload(); }
document.getElementById('btn-save').onclick=save;
document.getElementById('btn-load').onclick=load;
document.getElementById('btn-reset').onclick=reset;

/* ================= RENDERING ================= */
function clear(){
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#0b0f1a';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}
function colorFor(type){
  return ({
    'Scierie':'#c48a3a','Carri√®re':'#9aa3b2','Briqueterie':'#a6543a','Mine de fer':'#7d8aa6',
    'Entrep√¥t':'#3b4a75','Maison':'#d3b58f','Taverne':'#6e3b3b','Thermes':'#5d7f9a',
    'Forum':'#d2b35b','March√©':'#6a935f','Acad√©mie':'#5a6aa0','Temple':'#8a6ea0',
    'Caserne':'#6e705d','Port':'#4b6a7a','S√©nat':'#a09b6a'
  })[type]||'#888';
}
function drawGrid(){
  const size=S.grid.ts*S.cam.zoom;
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.translate(-S.cam.x*S.cam.zoom, -S.cam.y*S.cam.zoom);

  // ground
  ctx.fillStyle = '#111831';
  ctx.fillRect(-5000,-5000,10000,10000);

  // faint grid
  ctx.strokeStyle='rgba(255,255,255,.05)';
  ctx.lineWidth=1;
  ctx.beginPath();
  for(let x=0;x<=S.grid.w;x++){
    const xx=(x*S.grid.ts - S.grid.w*S.grid.ts/2)*S.cam.zoom;
    ctx.moveTo(xx,-S.grid.h*S.grid.ts/2*S.cam.zoom);
    ctx.lineTo(xx, S.grid.h*S.grid.ts/2*S.cam.zoom);
  }
  for(let y=0;y<=S.grid.h;y++){
    const yy=(y*S.grid.ts - S.grid.h*S.grid.ts/2)*S.cam.zoom;
    ctx.moveTo(-S.grid.w*S.grid.ts/2*S.cam.zoom, yy);
    ctx.lineTo(S.grid.w*S.grid.ts/2*S.cam.zoom, yy);
  }
  ctx.stroke();

  // buildings
  for(const b of S.city.buildings){
    drawBuilding(b);
  }

  // ghost preview
  if(S.input.mode==='build' && S.selectedToBuild && S.ghost){
    const {gx,gy,px,py}=S.ghost;
    ctx.save(); ctx.translate(px,py);
    const sz=S.grid.ts*S.cam.zoom-2;
    ctx.globalAlpha = 0.5;
    ctx.fillStyle=colorFor(S.selectedToBuild);
    roundRect(ctx,-sz/2,-sz/2,sz,sz,6*S.cam.zoom); ctx.fill();
    ctx.globalAlpha = 1.0;
    ctx.restore();
  }

  // FX
  for(const fx of S.fx){
    if(fx.kind==='pop'){
      const t=fx.t; const k=t/0.35;
      const s=1 + 0.2*Math.sin(k*Math.PI);
      ctx.save();
      ctx.translate(fx.px, fx.py);
      ctx.scale(s,s);
      ctx.fillStyle='rgba(255,255,255,.12)';
      ctx.beginPath(); ctx.arc(0,0, 18*S.cam.zoom, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }

  ctx.restore();
}
function drawBuilding(b){
  const px=(b.x*S.grid.ts - S.grid.w*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom;
  const py=(b.y*S.grid.ts - S.grid.h*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom;
  const sz=S.grid.ts*S.cam.zoom-2;
  ctx.save(); ctx.translate(px,py);
  ctx.fillStyle=colorFor(b.type);
  ctx.beginPath(); roundRect(ctx,-sz/2,-sz/2,sz,sz,6*S.cam.zoom); ctx.fill();

  // name bar
  ctx.fillStyle='#00000088'; ctx.fillRect(-sz/2,-sz/2,sz,18);
  ctx.fillStyle='#fff'; ctx.font=`${Math.max(10, 12*S.cam.zoom)}px system-ui`;
  ctx.fillText(`${b.type} Lv${b.lvl}`, -sz/2+4, -sz/2+13);

  // queue bar if any
  if(S.city.queue && S.city.queue.id===b.id){
    const q=S.city.queue; const p=clamp(q.progress/q.time,0,1);
    ctx.fillStyle='rgba(0,0,0,.35)';
    ctx.fillRect(-sz/2,sz/2-7,sz,6);
    ctx.fillStyle='#77d39c';
    ctx.fillRect(-sz/2,sz/2-7,sz*p,6);
  }
  ctx.restore();
}
function roundRect(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
}

/* ================= INPUT with GHOST ================= */
let lastTap=0;
function screenToWorld(px,py){
  const wx=(px - canvas.width/2)/S.cam.zoom + S.cam.x;
  const wy=(py - canvas.height/2)/S.cam.zoom + S.cam.y;
  const gx=Math.round((wx + S.grid.w*S.grid.ts/2 - S.grid.ts/2)/S.grid.ts);
  const gy=Math.round((wy + S.grid.h*S.grid.ts/2 - S.grid.ts/2)/S.grid.ts);
  const worldX = (gx*S.grid.ts - S.grid.w*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom;
  const worldY = (gy*S.grid.ts - S.grid.h*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom;
  return {gx,gy, px:worldX, py:worldY};
}
canvas.addEventListener('touchstart',(ev)=>{
  ev.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const touches=[...ev.touches].map(t=>({id:t.identifier,x:t.clientX-rect.left,y:t.clientY-rect.top}));
  touches.forEach(t=>S.input.touches.set(t.id,t));
  if(touches.length===1){
    S.input.longPress=setTimeout(()=>{
      const ww=screenToWorld(touches[0].x,touches[0].y);
      const b=findBuilding(ww.gx,ww.gy); if(b){ openSheet('D√©tails', sheetBuilding(b)); bindSheetBuilding(b); }
    },550);
  } else if(touches.length===2){
    const dx=touches[0].x - touches[1].x, dy=touches[0].y - touches[1].y;
    S.input.pinch=Math.hypot(dx,dy);
  }
},{passive:false});
canvas.addEventListener('touchmove',(ev)=>{
  ev.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const touches=[...ev.touches].map(t=>({id:t.identifier,x:t.clientX-rect.left,y:t.clientY-rect.top}));
  if(touches.length===1 && S.input.touches.size===1){
    const prev=[...S.input.touches.values()][0], curr=touches[0];
    if(S.input.mode==='build' && S.selectedToBuild){
      S.ghost = screenToWorld(curr.x,curr.y);
      showGhostTip(curr.x+rect.left, curr.y+rect.top);
    } else {
      S.cam.x -= (curr.x - prev.x)/S.cam.zoom;
      S.cam.y -= (curr.y - prev.y)/S.cam.zoom;
      hideGhostTip();
    }
    S.input.touches.set(curr.id,curr);
  } else if(touches.length===2){
    const dx=touches[0].x - touches[1].x, dy=touches[0].y - touches[1].y;
    const dist=Math.hypot(dx,dy);
    S.cam.zoom=clamp(S.cam.zoom + (dist - S.input.pinch)*0.004, 0.85, 6);
    S.input.pinch=dist;
    touches.forEach(t=>S.input.touches.set(t.id,t));
    hideGhostTip();
  }
},{passive:false});
canvas.addEventListener('touchend',(ev)=>{
  ev.preventDefault();
  if(S.input.longPress){ clearTimeout(S.input.longPress); S.input.longPress=null; }
  [...ev.changedTouches].forEach(t=>S.input.touches.delete(t.identifier));
  if(ev.changedTouches.length===1){
    const rect=canvas.getBoundingClientRect();
    const t=ev.changedTouches[0];
    const px=t.clientX-rect.left, py=t.clientY-rect.top;
    const nowT=Date.now();
    if(nowT-lastTap<250){ S.cam.x=0;S.cam.y=0; haptics(6); beep(520,0.05); hideGhostTip(); }
    else onTap(px,py);
    lastTap=nowT;
  }
},{passive:false});

function onTap(px,py){
  if(S.input.mode==='build' && S.selectedToBuild){
    // Confirm placement at ghost position
    const ww = S.ghost || screenToWorld(px,py);
    placeBuilding(S.selectedToBuild, ww.gx, ww.gy);
    hideGhostTip();
    return;
  }
  const ww=screenToWorld(px,py);
  const b=findBuilding(ww.gx,ww.gy);
  if(b){ openSheet('D√©tails', sheetBuilding(b)); bindSheetBuilding(b); }
}

/* Ghost tip helpers */
function showGhostTip(absX,absY){
  ghostTip.classList.remove('hidden');
  ghostTip.style.left = absX+'px';
  ghostTip.style.top = absY+'px';
}
function hideGhostTip(){ ghostTip.classList.add('hidden'); }

/* ================= GAME LOGIC ================= */
function findBuilding(x,y){ return S.city.buildings.find(b=>b.x===x && b.y===y); }
function canPlaceAt(x,y){ return !(x<0||y<0||x>=S.grid.w||y>=S.grid.h) && !findBuilding(x,y); }
function costFor(type,lvl){ const base=BDEF[type].baseCost||{}; const mult=1+(lvl-1)*0.35; const c={}; for(const k in base)c[k]=Math.floor(base[k]*mult); return c; }
function timeFor(type,lvl){ const base=BDEF[type].baseTime||5; return Math.floor(base*(1+(lvl-1)*0.25)); }
function canAfford(cost){ return Object.entries(cost).every(([k,v])=>(S.res[k]||0)>=v); }
function pay(cost){ for(const [k,v] of Object.entries(cost)) S.res[k]-=v; }
function refundHalf(cost){ for(const [k,v] of Object.entries(cost)) S.res[k]+=Math.floor(v*0.5); }

function placeBuilding(type,x,y){
  if(!canPlaceAt(x,y)){ toast('Emplacement indisponible'); beep(180,0.05,'sawtooth'); return; }
  if(BDEF[type].needsResearch && !S.city.research[BDEF[type].needsResearch]){ toast('Recherche requise: '+BDEF[type].needsResearch); beep(200,0.06,'sawtooth'); return; }
  const c=costFor(type,1);
  if(!canAfford(c)){ toast('Ressources insuffisantes'); beep(200,0.06,'sawtooth'); return; }
  if(S.city.queue){ toast('File occup√©e'); beep(200,0.06,'sawtooth'); return; }
  pay(c);
  const b={id:crypto.randomUUID(),type,x,y,lvl:0};
  const t=timeFor(type,1);
  S.city.queue={id:b.id,action:'build',type,level:1,time:t,progress:0,payload:b};
  toast(`Construction: ${type} (${t}s)`);
  haptics(10); beep(600,0.05,'square',0.04);
}

function tryUpgrade(b){
  const next=b.lvl+1, c=costFor(b.type,next);
  if(!canAfford(c)) return toast('Ressources insuffisantes'), beep(200,0.06,'sawtooth');
  if(S.city.queue) return toast('File occup√©e'), beep(200,0.06,'sawtooth');
  pay(c);
  const t=timeFor(b.type,next);
  S.city.queue={id:b.id,action:'upgrade',type:b.type,level:next,time:t,progress:0};
  toast(`Am√©lioration: ${b.type} Lv${next} (${t}s)`);
  haptics(10); beep(650,0.05,'square',0.04);
}

function cancelQueue(){
  if(!S.city.queue) return;
  const q=S.city.queue;
  if(q.action==='build') refundHalf(costFor(q.type,1));
  else refundHalf(costFor(q.type,q.level));
  S.city.queue=null; toast('File annul√©e (+50%)'); haptics(6); beep(300,0.05,'triangle',0.04);
}

function applyBuildingEffects(b,sign){
  const d=BDEF[b.type];
  if(d.rate){ for(const [k,v] of Object.entries(d.rate)) S.rates[k]=(S.rates[k]||0)+v*sign; }
  if(d.storage){ for(const [k,v] of Object.entries(d.storage)) S.res.storage[k]=(S.res.storage[k]||0)+v*sign; }
  if(d.pop){ for(const [k,v] of Object.entries(d.pop)) S.res[k]=(S.res[k]||0)+v*sign; }
  if(d.happy){ S.res.bonheur=clamp(S.res.bonheur+d.happy*sign,0,200); }
}

function onQueueDone(q){
  const pos = toScreenCenter();
  if(q.action==='build'){ const b=q.payload; b.lvl=1; S.city.buildings.push(b); applyBuildingEffects(b,+1); pushPopFX(b); }
  else { const b=S.city.buildings.find(x=>x.id===q.id); if(!b) return; applyBuildingEffects(b,-b.lvl); b.lvl=q.level; applyBuildingEffects(b,+b.lvl); pushPopFX(b); }
  S.city.queue=null;
  rebuildResbar(); haptics(12); beep(760,0.06,'square',0.05);
}
function pushPopFX(b){
  const {px,py}=gridToPx(b.x,b.y);
  S.fx.push({kind:'pop', px, py, t:0});
}

function gridToPx(x,y){
  // convert grid coords to current screen space position
  const px=(x*S.grid.ts - S.grid.w*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom + canvas.width/2 - S.cam.x*S.cam.zoom;
  const py=(y*S.grid.ts - S.grid.h*S.grid.ts/2 + S.grid.ts/2)*S.cam.zoom + canvas.height/2 - S.cam.y*S.cam.zoom;
  return {px,py};
}
function toScreenCenter(){ return {x:canvas.width/2,y:canvas.height/2}; }

/* ================= SYSTEMS TICK ================= */
function tick(dt){
  const eff=getEffectiveRates();
  for(const k of ['bois','pierre','argile','fer','or','vin','science']){
    const cap=S.res.storage[k]??Infinity; S.res[k]=clamp(S.res[k]+(eff[k]||0)*dt,0,cap);
  }
  const freeBeds=Math.max(0,S.res.logements - S.res.pop);
  const happyFactor=clamp((S.res.bonheur-80)/100,0,1.2);
  const popGrowth=freeBeds>0 ? 0.02*happyFactor : -0.01*(1-happyFactor);
  S.res.pop=clamp(S.res.pop + popGrowth*dt, 0, 9999);

  if(S.city.queue){ S.city.queue.progress+=dt; if(S.city.queue.progress>=S.city.queue.time) onQueueDone(S.city.queue); }

  // FX
  for(const fx of S.fx){ fx.t+=dt; }
  S.fx = S.fx.filter(f=>f.t<0.35);
}

/* ================= UI LAYER ================= */
function rebuildResbar(){
  const R=[["üå≤","bois"],["ü™®","pierre"],["üß±","argile"],["‚õìÔ∏è","fer"],["ü™ô","or"],["üç∑","vin"],["üß†","science"],["üë•","pop"],["üôÇ","bonheur"]];
  const eff=getEffectiveRates();
  resbar.innerHTML = R.map(([i,k])=>{
    const hasRate = typeof eff[k]==='number' && Math.abs(eff[k])>0.0001;
    const rate = hasRate ? ` <span class=\"small\" style=\"opacity:.8\">(${eff[k]>0?'+':''}${(eff[k]).toFixed(2)}/s)</span>` : '';
    return `<div class=\"res-chip\"><span>${i}</span><b>${fmt(S.res[k]??0)}</b>${rate}</div>`;
  }).join('');
}
function openSheet(title, html){ sheetTitle.textContent=title; sheetBody.innerHTML=html; sheet.classList.add('show'); sheet.setAttribute('aria-hidden','false'); }
function closeSheet(){ sheet.classList.remove('show'); sheet.setAttribute('aria-hidden','true'); }
sheet.addEventListener('click',(e)=>{ if(e.target===sheet) closeSheet(); });

function sheetBuild(){
  const cats=['prod','util','bonheur','science','eco','mil','centre','culture'];
  let html='';
  for(const cat of cats){
    const list=Object.entries(BDEF).filter(([k,v])=>v.cat===cat);
    if(!list.length) continue;
    html+=`<div class="small" style="text-transform:uppercase;margin-top:6px">${cat}</div>`;
    for(const [name,def] of list){
      const c=costFor(name,1);
      const costStr=Object.entries(c).map(([k,v])=>`${icon(k)} ${v}`).join(' ');
      const locked = def.needsResearch && !S.city.research[def.needsResearch];
      html+=`<div class="card">
        <div class="row"><b>${name}</b>${locked?`<span class="tag">üîí ${def.needsResearch}</span>`:''}</div>
        <div class="small">${costStr}</div>
        <div class="row"><button class="btn" ${locked?'disabled':''} data-build="${name}">Pr√©visualiser</button></div>
      </div>`;
    }
  }
  return html;
}
function sheetResearch(){
  let html='';
  for(const [name,r] of Object.entries(RESEARCH)){
    const done=!!S.city.research[name]; const afford=(S.res.science||0) >= (r.cost.science||0);
    html+=`<div class="card">
      <div class="row"><b>${name}</b><span class="small">${done?'Termin√©':'D√©bloque: '+r.unlocks.join(', ')}</span></div>
      <div class="row">
        <span class="small">Co√ªt: üß† ${r.cost.science}</span>
        ${done?'<span class="tag">‚úî</span>':`<button class="btn" data-r="${name}" ${afford?'':'disabled'}>√âtudier</button>`}
      </div>
    </div>`;
  }
  return html;
}
function sheetArmy(){
  const hasBarracks=S.city.buildings.some(b=>b.type==='Caserne');
  let html=`<div class="row"><div><b>L√©gionnaires</b><div class="small">Actuels: ${S.city.army.legion}</div></div>
    <button class="btn" id="rc-legion" ${hasBarracks?'':'disabled'}>Recruter (ü™®10 ‚õìÔ∏è5 ü™ô2 üë•1)</button></div>`;
  if(!hasBarracks) html+=`<div class="small">Construis une <b>Caserne</b> pour recruter des troupes.</div>`;
  return html;
}
function sheetWorld(){
  let html='';
  for(const p of (S.world?.provinces||[])){
    const owned = p.owner===S.world.playerFaction;
    const ystr = Object.entries(p.yields).map(([k,v])=>`${icon(k)} +${v.toFixed(2)}/s`).join(' ');
    const st = S.world.diplo[p.owner];
    const war = st? st.war:false;
    html+=`<div class="card">
      <div class="row"><b>${p.name}</b><span class="tag">${owned?'Poss√©d√©e':('‚õ≥ '+p.owner)}</span></div>
      <div class="small">${ystr}</div>
      <div class="small">Garnison: ${p.garrison.legion}</div>
      <div class="row">
        ${owned?'<span class="small">Sous contr√¥le</span>':`<button class="btn" data-attack="${p.id}">${war?'Attaquer':'Attaquer (n√©cessite guerre)'}</button>`}
      </div>
    </div>`;
  }
  return html;
}
function sheetDiplo(){
  let html='';
  for(const f of (S.world?.factions||[])){
    const st=S.world.diplo[f];
    html+=`<div class="card">
      <div class="row"><b>${f}</b><span class="tag">Relation ${st.relation}</span></div>
      <div class="row"><span class="small">${st.war?'‚öîÔ∏è En guerre':'üïäÔ∏è Paix'}</span></div>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <button class="btn" data-rel="${f}">Am√©liorer (+10) ‚Äî ü™ô50</button>
        ${st.war?`<button class="btn" data-peace="${f}">Proposer paix</button>`:`<button class="btn" data-war="${f}">D√©clarer la guerre</button>`}
        <button class="btn" data-trade="${f}" ${st.relation>=40 && !st.trade?'' :'disabled'}>${st.trade?'Commerce actif':'Accord commercial ‚Äî ü™ô30 (rel‚â•40)'}</button>
      </div>
    </div>`;
  }
  return html;
}
function bindSheetWorld(){
  sheetBody.querySelectorAll('[data-attack]').forEach(btn=>{
    btn.onclick=()=>{
      const pid=btn.dataset.attack; const p=S.world.provinces.find(x=>x.id===pid);
      const st=S.world.diplo[p.owner];
      if(p.owner!==S.world.playerFaction && st && !st.war){ toast('D√©clarez la guerre √† '+p.owner+' dans Diplomatie.'); beep(200,0.06,'sawtooth'); return; }
      const max=S.city.army.legion;
      const nStr=prompt(`Combien de l√©gionnaires envoyer ? (max ${max})`,`${Math.min(5,max)}`);
      if(!nStr) return; const n=Number(nStr)|0;
      const res=resolveBattle(n,pid);
      toast(res.msg); rebuildResbar(); openSheet('Monde', sheetWorld()); bindSheetWorld();
      beep(res.ok?640:260,0.06,res.ok?'square':'sawtooth',0.05);
    };
  });
}
function bindSheetDiplo(){
  sheetBody.querySelectorAll('[data-rel]').forEach(b=>b.onclick=()=>{
    const f=b.dataset.rel; const st=S.world.diplo[f];
    if((S.res.or||0)<50) return toast('Or insuffisant');
    S.res.or-=50; st.relation=Math.min(100, st.relation+10); rebuildResbar(); openSheet('Diplomatie', sheetDiplo()); bindSheetDiplo(); beep(560,0.04,'triangle');
  });
  sheetBody.querySelectorAll('[data-war]').forEach(b=>b.onclick=()=>{
    const f=b.dataset.war; const st=S.world.diplo[f]; st.war=true; st.relation=Math.max(-100, st.relation-30);
    toast('Guerre d√©clar√©e √† '+f); openSheet('Diplomatie', sheetDiplo()); bindSheetDiplo(); beep(420,0.06,'sawtooth');
  });
  sheetBody.querySelectorAll('[data-peace]').forEach(b=>b.onclick=()=>{
    const f=b.dataset.peace; const st=S.world.diplo[f]; st.war=false; st.relation=Math.min(100, st.relation+5);
    toast('Paix sign√©e avec '+f); openSheet('Diplomatie', sheetDiplo()); bindSheetDiplo(); beep(600,0.05,'square');
  });
  sheetBody.querySelectorAll('[data-trade]').forEach(b=>b.onclick=()=>{
    const f=b.dataset.trade; const st=S.world.diplo[f];
    if(st.trade) return; if(st.relation<40) return toast('Relation insuffisante'); if((S.res.or||0)<30) return toast('Or insuffisant');
    S.res.or-=30; st.trade=true; rebuildResbar(); toast('Accord commercial avec '+f); openSheet('Diplomatie', sheetDiplo()); bindSheetDiplo(); beep(640,0.05,'triangle');
  });
}
function sheetMenu(){
  const themes=['default','sepia','ivory','contrast'];
  const themeBtns = themes.map(t=>`<button class="btn" data-theme="${t}">${t}</button>`).join('');
  return `<div class="row">
    <div>
      <div><b>File</b></div>
      <div class="small">${S.city.queue? `${S.city.queue.action} ${S.city.queue.type} ‚Äî reste ${Math.ceil(S.city.queue.time - S.city.queue.progress)}s` : 'vide'}</div>
    </div>
    <button class="btn" id="btn-cancel" ${S.city.queue?'':'disabled'}>Annuler</button>
  </div>
  <div class="card">
    <div class="row"><b>Mode</b><span class="small">${S.input.mode}</span></div>
    <div class="row"><button class="btn" id="m-select">S√©lection</button><button class="btn" id="m-build">Construction</button><button class="btn" id="m-up">Am√©lioration</button></div>
  </div>
  <div class="card">
    <div class="row"><b>Th√®me</b><span class="small">${S.ui.theme}</span></div>
    <div class="row" style="gap:6px;flex-wrap:wrap">${themeBtns}</div>
  </div>
  <div class="card">
    <div class="row"><b>Son</b><span class="small">${S.ui.sound?'activ√©':'coup√©'}</span></div>
    <div class="row"><button class="btn" id="snd-on">Activer</button><button class="btn" id="snd-off">Couper</button></div>
  </div>`;
}
function sheetBuilding(b){
  const d=BDEF[b.type]; const next=costFor(b.type,b.lvl+1);
  const nextStr=Object.entries(next).map(([k,v])=>`${icon(k)} ${v}`).join(' ');
  let eff=[];
  if(d.rate) eff.push('Production: '+Object.entries(d.rate).map(([k,v])=>`${icon(k)} +${v}/s`).join(' '));
  if(d.storage) eff.push('Stockage: '+Object.entries(d.storage).map(([k,v])=>`${icon(k)} +${v}`).join(' '));
  if(d.pop?.logements) eff.push(`Logements: +${d.pop.logements}`);
  if(d.happy) eff.push(`Bonheur: +${d.happy}`);
  return `<div class="card pop">
      <div class="row"><b>${b.type}</b><span class="tag">Niveau ${b.lvl}</span></div>
      <div class="small">${eff.join(' ‚Ä¢ ') || 'Aucun effet'}</div>
      <div class="row"><button class="btn" id="b-up">Am√©liorer (${nextStr})</button></div>
    </div>` + sheetMenu();
}
function bindSheetBuilding(b){
  const up=document.getElementById('b-up'); if(up) up.onclick=()=>{ tryUpgrade(b); openSheet('D√©tails', sheetBuilding(b)); bindSheetBuilding(b); rebuildResbar(); };
  bindSheetMenu();
}
function icon(k){ return ({bois:'üå≤',pierre:'ü™®',argile:'üß±',fer:'‚õìÔ∏è',or:'ü™ô',vin:'üç∑',science:'üß†',pop:'üë•'})[k]||k; }

/* ================= DOCK & SHEET BEHAVIOR ================= */
document.querySelectorAll('.dock .i').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('.dock .i').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const tab=btn.dataset.tab; S.ui.tab=tab;
  if(tab==='city'){ closeSheet(); }
  else if(tab==='build'){ openSheet('Construire', sheetBuild()); bindSheetBuild(); }
  else if(tab==='research'){ openSheet('Recherches', sheetResearch()); bindSheetResearch(); }
  else if(tab==='army'){ openSheet('Arm√©e', sheetArmy()); bindSheetArmy(); }
  else if(tab==='world'){ openSheet('Monde', sheetWorld()); bindSheetWorld(); }
  else if(tab==='diplo'){ openSheet('Diplomatie', sheetDiplo()); bindSheetDiplo(); }
  else if(tab==='menu'){ openSheet('Menu', sheetMenu()); bindSheetMenu(); }
  haptics(8); beep(500+rnd(-50,50),0.03,'square',0.03);
});
document.getElementById('fab').onclick=()=>{
  S.ui.tab='build';
  document.querySelectorAll('.dock .i').forEach(b=>b.classList.remove('active'));
  document.querySelector('.dock .i[data-tab="build"]').classList.add('active');
  openSheet('Construire', sheetBuild()); bindSheetBuild();
  haptics(10); beep(520,0.04,'square',0.04);
};
document.getElementById('btn-settings').onclick=()=>{
  openSheet('R√©glages', `<div class="card">
    <div class="row"><b>Vitesse</b><span class="small">x${S.time.speed.toFixed(1)}</span></div>
    <div class="row"><button class="btn" id="spd-1">x1</button><button class="btn" id="spd-2">x1.5</button><button class="btn" id="spd-3">x2</button></div>
  </div>` + sheetMenu());
  document.getElementById('spd-1').onclick=()=>S.time.speed=1;
  document.getElementById('spd-2').onclick=()=>S.time.speed=1.5;
  document.getElementById('spd-3').onclick=()=>S.time.speed=2;
  bindSheetMenu();
};

/* Sheet binders */
function bindSheetBuild(){
  sheetBody.querySelectorAll('[data-build]').forEach(btn=>{
    btn.onclick=()=>{
      S.selectedToBuild=btn.dataset.build; S.input.mode='build'; toast('Glisse pour viser, tap pour confirmer.');
      closeSheet();
    };
  });
}
function bindSheetResearch(){
  sheetBody.querySelectorAll('[data-r]').forEach(btn=>{
    btn.onclick=()=>{
      const name=btn.dataset.r, r=RESEARCH[name];
      if((S.res.science||0) >= r.cost.science){
        S.res.science -= r.cost.science; S.city.research[name]=true;
        toast('Recherche termin√©e: '+name); rebuildResbar(); openSheet('Recherches', sheetResearch()); bindSheetResearch();
        beep(720,0.05,'triangle',0.04);
      } else { beep(180,0.06,'sawtooth',0.05); }
    };
  });
}
function bindSheetArmy(){
  const rc=document.getElementById('rc-legion');
  if(rc) rc.onclick=()=>{
    const cost={pierre:10, fer:5, or:2, pop:1};
    if(S.res.pop<1) return toast('Population insuffisante'), beep(200,0.06,'sawtooth');
    if(!canAfford(cost)) return toast('Ressources insuffisantes'), beep(200,0.06,'sawtooth');
    pay(cost); S.city.army.legion+=1; toast('L√©gionnaire recrut√© ('+S.city.army.legion+')'); rebuildResbar(); beep(560,0.05,'square',0.04);
  };
}
function bindSheetMenu(){
  const c=document.getElementById('btn-cancel'); if(c) c.onclick=cancelQueue;
  const ms=document.getElementById('m-select'); if(ms) ms.onclick=()=>{S.input.mode='select'; toast('Mode s√©lection');};
  const mb=document.getElementById('m-build'); if(mb) mb.onclick=()=>{S.input.mode='build'; toast('Mode construction');};
  const mu=document.getElementById('m-up'); if(mu) mu.onclick=()=>{S.input.mode='upgrade'; toast('Mode am√©lioration');};
  document.querySelectorAll('[data-theme]').forEach(b=>b.onclick=()=>{ S.ui.theme=b.dataset.theme; localStorage.setItem('imperium-theme',S.ui.theme); document.documentElement.setAttribute('data-theme',S.ui.theme); });
  const so=document.getElementById('snd-on'); if(so) so.onclick=()=>{S.ui.sound=true; toast('Son activ√©');};
  const sf=document.getElementById('snd-off'); if(sf) sf.onclick=()=>{S.ui.sound=false; toast('Son coup√©');};
}

/* ================= TOAST ================= */
let toastTimeout=null;
function toast(msg){
  const t=document.createElement('div'); t.className='toast t'; t.textContent=msg; document.body.appendChild(t);
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout=setTimeout(()=>t.remove(),1500);
}

/* ================= ONBOARDING ================= */
const ob=document.getElementById('ob'); const obTitle=document.getElementById('ob-title'); const obBody=document.getElementById('ob-body');
const obNext=document.getElementById('ob-next'); const obSkip=document.getElementById('ob-skip');
const OBK='imperium-onboarding-v1';
let obStep = localStorage.getItem(OBK)? 999 : 0;
const steps=[
  {title:'Bienvenue dans Imperium', body:'Glissez pour d√©placer la carte. Pincez pour zoomer. Double-tap pour recentrer.'},
  {title:'Construire', body:'Appuyez üèóÔ∏è ou onglet üß±, choisissez un b√¢timent, puis glissez pour viser et tapez pour confirmer le placement.'},
  {title:'Panneaux', body:'Ouvrez les onglets en bas : üß™ Recherches, üõ°Ô∏è Arm√©e, ‚ò∞ Menu (th√®mes, vitesse, son). Bon jeu !'}
];
function showOnboarding(){
  if(obStep>=steps.length) { ob.classList.remove('show'); localStorage.setItem(OBK,'done'); return; }
  const s=steps[obStep]; obTitle.textContent=s.title; obBody.textContent=s.body; ob.classList.add('show');
}
if(obStep===0) showOnboarding();
obNext.onclick=()=>{ obStep++; showOnboarding(); beep(520,0.04); };
obSkip.onclick=()=>{ obStep=999; showOnboarding(); };

/* ================= MAIN LOOP ================= */
function frame(){
  const n=performance.now(); S.time.dt = (n - S.time.last)/1000 * S.time.speed; S.time.last=n;
  tick(S.time.dt); clear(); drawGrid();
  requestAnimationFrame(frame);
}

/* ================= BOOTSTRAP ================= */
function start(){
  initWorld();
  if(S.city.buildings.length===0){
    const cx=Math.floor(S.grid.w/2), cy=Math.floor(S.grid.h/2);
    const seed=[
      {type:'Forum',dx:0,dy:0},
      {type:'Scierie',dx:2,dy:0},
      {type:'Carri√®re',dx:-2,dy:0},
      {type:'Briqueterie',dx:0,dy:2},
      {type:'Entrep√¥t',dx:0,dy:-2},
      {type:'Maison',dx:3,dy:1}
    ];
    for(const s of seed){
      const b={id:crypto.randomUUID(),type:s.type,x:cx+s.dx,y:cy+s.dy,lvl:1};
      S.city.buildings.push(b); applyBuildingEffects(b,+1);
    }
  }
  rebuildResbar();
  requestAnimationFrame(frame);
}
start();

})();</script>
</body>
</html>
