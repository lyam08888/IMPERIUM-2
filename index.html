<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IMPERIUM - Ma Cit√© : Roma Aeterna V18</title>
    <meta name="description" content="G√©rez votre cit√© romaine dans IMPERIUM - Construisez, d√©veloppez, prosp√©rez.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">

    <style>
        :root {
            --gold-primary: #d97706; --gold-secondary: #f59e0b; --gold-light: #fbbf24;
            --marble-white: #f8fafc; --roman-red: #dc2626; --roman-purple: #7c3aed;
            --dark-stone: #1e293b; --dark-marble: #334155; --dark-bg: #0f172a;
            --text-light: #e2e8f0; --text-muted: #94a3b8;
            --border-gold: rgba(217, 119, 6, 0.3); --shadow-gold: rgba(217, 119, 6, 0.4);
            --success-green: #22c55e; --error-red: #ef4444;
            --xp-color: #7c3aed;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Times New Roman', serif;
            background: 
                radial-gradient(circle at 20% 20%, rgba(217, 119, 6, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
            color: var(--text-light);
            overflow-y: auto;
        }
        .imperium-ui { display: flex; flex-direction: column; min-height: 100vh; position: relative; z-index: 10; padding-bottom: 80px; /* Space for footer */ }
        .imperium-body { max-width: 1200px; margin: 0 auto; width: 100%; padding: 1.5rem 2rem; }
        .view-title { font-size: 2.2rem; font-weight: bold; color: var(--gold-primary); margin-bottom: 2rem; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .city-map-section { background: rgba(15, 23, 42, 0.8); border-radius: 1rem; border: 1px solid var(--border-gold); padding: 1.5rem; margin-bottom: 2rem; }
        .map-header { margin-bottom: 2rem; } /* Espace ajout√© ici */
        .buildings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; min-height: 400px; }
        @media (min-width: 768px) { .buildings-grid { grid-template-columns: repeat(5, 1fr); } }
        .building-slot { background: rgba(30, 41, 59, 0.6); border: 2px dashed var(--text-muted); border-radius: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; min-height: 120px; padding: 0.5rem; position: relative; }
        .building-slot:hover:not(.constructing) { border-color: var(--gold-light); background: rgba(217, 119, 6, 0.15); transform: translateY(-5px); }
        .building-slot.occupied { border-style: solid; border-color: var(--border-gold); }
        .building-slot.constructing { cursor: not-allowed; background: rgba(124, 58, 237, 0.2); border-color: var(--xp-color); border-style: solid;}
        .building-icon { font-size: 2.5rem; margin-bottom: 0.5rem; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }
        .building-name { color: var(--text-light); font-weight: bold; font-size: 0.9rem; text-align: center; }
        .building-level { color: var(--gold-light); font-size: 0.8rem; font-weight: bold; margin-top: 0.3rem; padding: 0.2rem 0.5rem; background: rgba(217, 119, 6, 0.2); border-radius: 1rem; }
        .construction-timer { position: absolute; bottom: 5px; left: 0; right: 0; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--gold-light); background: rgba(0,0,0,0.5); padding: 2px 0; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .dashboard-tile { background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border-gold); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; }
        .dashboard-tile:hover { transform: translateY(-5px); box-shadow: 0 5px 20px var(--shadow-gold); border-color: var(--gold-primary); }
        .tile-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .tile-icon { font-size: 2rem; }
        .tile-title { font-size: 1.3rem; font-weight: bold; color: var(--gold-light); }
        .tile-preview { font-size: 0.9rem; color: var(--text-muted); }
        .imperium-btn { background: linear-gradient(145deg, var(--gold-secondary), var(--gold-primary)); color: white; border: none; border-radius: 0.5rem; padding: 0.8rem 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.2s ease; font-family: 'Times New Roman', serif; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); box-shadow: 0 2px 5px rgba(0,0,0,0.2), inset 0 -2px 2px rgba(0,0,0,0.2); }
        .imperium-btn.danger { background: linear-gradient(145deg, var(--roman-red), #991b1b); }
        .imperium-btn:hover { filter: brightness(1.1); box-shadow: 0 4px 10px var(--shadow-gold), inset 0 -2px 2px rgba(0,0,0,0.2); }
        .imperium-btn:active { transform: translateY(1px); box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 0 2px rgba(0,0,0,0.3); filter: brightness(1); }
        .imperium-btn:disabled { background: var(--dark-marble); cursor: not-allowed; color: var(--text-muted); transform: none; box-shadow: none; filter: none; }
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .modal-container.active { pointer-events: all; }
        .modal-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .modal-container.active .modal-backdrop { opacity: 1; }
        .modal-content { background: linear-gradient(135deg, var(--dark-stone), var(--dark-bg)); border: 2px solid var(--gold-primary); border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 600px; z-index: 1001; transform: scale(0.9) translateY(20px); opacity: 0; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-container.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-gold); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.8rem; color: var(--gold-light); text-shadow: 1px 1px 3px var(--shadow-gold); }
        .modal-close-btn { background: none; border: none; color: var(--text-muted); font-size: 2rem; cursor: pointer; transition: color 0.3s; }
        .modal-body { padding: 1rem; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-top: 1px solid var(--border-gold); gap: 1rem; background: rgba(0,0,0,0.2); }
        .upgrade-info { background: rgba(15, 23, 42, 0.7); border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; border: 1px solid var(--border-gold); }
        .build-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.75rem; }
        .build-item { background: rgba(15, 23, 42, 0.7); border: 1px solid var(--border-gold); border-radius: 0.75rem; padding: 0.75rem; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .build-item:not(.disabled):hover { background: rgba(217, 119, 6, 0.15); transform: translateY(-5px); box-shadow: 0 5px 15px var(--shadow-gold); }
        .build-item.disabled { opacity: 0.6; cursor: not-allowed; background: rgba(30, 41, 59, 0.4); }
        .build-item-icon { font-size: 1.8rem; }
        .build-item-name { font-weight: bold; margin: 0.25rem 0; color: var(--gold-light); font-size: 0.9rem; }
        .build-item-costs { font-size: 0.75rem; color: var(--text-muted); }
        .build-item-prereq { color: var(--error-red); font-size: 0.7rem; font-style: italic; margin-top: 0.25rem; }
        .quest-panel { text-align: center; }
        .quest-title { font-weight: bold; color: var(--gold-light); }
        .quest-reward { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; }
        .construction-footer { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, var(--dark-marble) 0%, var(--dark-stone) 100%); border-top: 2px solid var(--border-gold); padding: 0.5rem 1rem; z-index: 100; display: none; align-items: center; gap: 1rem; }
        .construction-footer.active { display: flex; }
        .footer-item { display: flex; align-items: center; gap: 1rem; }
        .footer-icon { font-size: 2rem; }
        .footer-details { flex-grow: 1; }
        .footer-progress-bar { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .footer-progress-fill { height: 100%; background: var(--xp-color); width: 0%; transition: width 0.5s linear; }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .toast { padding: 0.8rem 1.5rem; border-radius: 2rem; color: white; font-weight: bold; background: linear-gradient(135deg, var(--dark-marble), var(--dark-stone)); border: 1px solid var(--gold-primary); box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: toast-in 0.5s ease, toast-out 0.5s ease 3.5s; opacity: 0; }
        .toast.success { background: linear-gradient(135deg, #16a34a, #15803d); border-color: #4ade80; }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); border-color: #f87171; }
        .toast.levelup { background: linear-gradient(135deg, var(--xp-color), #a855f7); border-color: var(--gold-light); font-size: 1.2rem; padding: 1rem 2rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-button { position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--gold-primary); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .nav-popup { position: fixed; top: 70px; right: 20px; background: var(--dark-stone); border: 1px solid var(--border-gold); border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 1000; }
        .nav-popup a { color: var(--text-light); padding: 0.5rem 1rem; text-decoration: none; white-space: nowrap; }
        .nav-popup a:hover { background: var(--dark-marble); }
        .nav-popup.active { display: flex; }
    </style>
</head>
<body>
    <button class="nav-button" id="navButton">‚ò∞</button>
    <div class="nav-popup" id="navPopup">
        <a href="index.html">Accueil</a>
        <a href="page2.html">Page 2</a>
    </div>
    <div class="imperium-ui">
        <div class="imperium-body">
            <main class="main-content">
                <div id="city-view" class="view-container active">
                    <div class="city-map-section">
                        <div class="map-header">
                            <h2 class="map-title">Plan de la Cit√©</h2>
                        </div>
                        <div class="buildings-grid" id="buildingsGrid"></div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="dashboard-tile" onclick="showPlayerModal()">
                            <div class="tile-header">
                                <span class="tile-icon">üë§</span>
                                <h3 class="tile-title">Profil du Consul</h3>
                            </div>
                            <div class="tile-preview" id="player-tile-preview"></div>
                        </div>
                        <div class="dashboard-tile" onclick="showResourcesModal()">
                             <div class="tile-header">
                                <span class="tile-icon">üí∞</span>
                                <h3 class="tile-title">Ressources</h3>
                            </div>
                            <div class="tile-preview" id="resources-tile-preview"></div>
                        </div>
                        <div class="dashboard-tile" onclick="showStatsModal()">
                             <div class="tile-header">
                                <span class="tile-icon">üìä</span>
                                <h3 class="tile-title">Statistiques</h3>
                            </div>
                            <div class="tile-preview" id="stats-tile-preview"></div>
                        </div>
                        <div class="dashboard-tile" onclick="showProductionModal()">
                             <div class="tile-header">
                                <span class="tile-icon">üìà</span>
                                <h3 class="tile-title">Production</h3>
                            </div>
                            <div class="tile-preview" id="production-tile-preview"></div>
                        </div>
                        <div class="dashboard-tile" onclick="showQuestModal()">
                             <div class="tile-header">
                                <span class="tile-icon">üéØ</span>
                                <h3 class="tile-title">Objectif Actuel</h3>
                            </div>
                            <div class="tile-preview" id="quest-tile-preview"></div>
                        </div>
                        <div class="dashboard-tile" onclick="showActionsModal()">
                             <div class="tile-header">
                                <span class="tile-icon">‚ö°</span>
                                <h3 class="tile-title">Actions Rapides</h3>
                            </div>
                            <div class="tile-preview">Collecter les imp√¥ts, organiser des jeux...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="construction-footer" class="construction-footer"></div>
    <div id="modal-container" class="modal-container"></div>
    <div id="toast-container"></div>

    <script>
    // ===============================================================
    // V18 - D√âFINITIONS ET √âTAT DU JEU
    // ===============================================================
    const BUILDING_DEFINITIONS = {
        'forum': { name: 'Forum Romain', icon: 'üèõÔ∏è', description: 'Le coeur politique et social de votre cit√©.',
            baseCost: [{ res: 'gold', amount: 100 }, { res: 'marble', amount: 50 }], upgradeCostMultiplier: 1.8,
            production: { happiness: 2 }, baseBuildTime: 30, xpGain: 50, isInteractive: true },
        'market': { name: 'March√©', icon: 'üè™', description: 'Permet d\'√©changer des ressources. Am√©liorez-le pour de meilleures offres.',
            baseCost: [{ res: 'gold', amount: 80 }, { res: 'food', amount: 20 }], upgradeCostMultiplier: 1.6,
            production: { gold: 20 }, baseBuildTime: 20, xpGain: 30, isInteractive: true },
        'farm': { name: 'Ferme', icon: 'üßë‚Äçüåæ', description: 'Produit la nourriture pour votre peuple.',
            baseCost: [{ res: 'gold', amount: 60 }], upgradeCostMultiplier: 1.5,
            production: { food: 25 }, baseBuildTime: 15, xpGain: 25 },
        'quarry': { name: 'Carri√®re', icon: '‚õèÔ∏è', description: 'Extrait le marbre n√©cessaire aux grandes constructions.',
            baseCost: [{ res: 'gold', amount: 120 }, { res: 'food', amount: 50 }], upgradeCostMultiplier: 1.6,
            production: { marble: 15 }, baseBuildTime: 45, xpGain: 60 },
        'warehouse': { name: 'Entrep√¥t', icon: 'üì¶', description: 'Augmente le stockage d\'or et de marbre.',
            baseCost: [{ res: 'food', amount: 100 }], upgradeCostMultiplier: 2.0,
            storage: { gold: 1000, marble: 500 }, baseBuildTime: 40, xpGain: 40 },
        'granary': { name: 'Grenier', icon: 'üåæ', description: 'Augmente le stockage de nourriture.',
            baseCost: [{ res: 'gold', amount: 80 }], upgradeCostMultiplier: 1.8,
            storage: { food: 1500 }, baseBuildTime: 35, xpGain: 35 },
        'insula': { name: 'Insula', icon: 'üèòÔ∏è', description: 'Fournit des logements pour votre population.',
            baseCost: [{ res: 'food', amount: 50 }, { res: 'marble', amount: 20 }], upgradeCostMultiplier: 1.7,
            housing: 50, baseBuildTime: 25, xpGain: 20 },
        'pantheon': { name: 'Panth√©on', icon: 'üèõÔ∏è‚ú®', description: 'Honorez les dieux et recevez leurs b√©n√©dictions.',
            baseCost: [{ res: 'gold', amount: 1000 }, { res: 'marble', amount: 500 }], upgradeCostMultiplier: 3.0,
            baseBuildTime: 600, xpGain: 500, requires: { type: 'forum', level: 5 }, isInteractive: true },
    };
    
    const QUESTS = [
        { id: 0, description: "Construisez votre premi√®re Ferme.", isComplete: () => gameState.buildings.some(b => b.type === 'farm'), reward: { xp: 50, resources: [{res: 'gold', amount: 100}] } },
        { id: 1, description: "Atteignez le niveau 2.", isComplete: () => gameState.player.level >= 2, reward: { xp: 0, resources: [{res: 'marble', amount: 50}] } },
        { id: 2, description: "Construisez une Insula pour votre peuple.", isComplete: () => gameState.buildings.some(b => b.type === 'insula'), reward: { xp: 100, resources: [{res: 'food', amount: 200}] } },
        { id: 3, description: "Construisez un March√© pour commercer.", isComplete: () => gameState.buildings.some(b => b.type === 'market'), reward: { xp: 150, resources: [{res: 'gold', amount: 300}] } },
    ];

    function getDefaultGameState() {
        return {
            player: { name: 'Marcus Aurelius', title: 'Consul', level: 1, xp: 0, avatar: 'M' },
            resources: { gold: 500, food: 200, marble: 100, divineFavor: 0 },
            storage: { gold: 1000, food: 1500, marble: 500, divineFavor: 100 },
            stats: { population: 50, populationCapacity: 50, happiness: 75, happinessModifier: 1.0 },
            production: { gold: 5, food: 10, marble: 2, happiness: 0, divineFavor: 0 },
            buildings: Array.from({ length: 15 }, (_, i) => ({ slotId: i, type: null, level: 0 })),
            constructionQueue: [],
            activeQuestId: 0,
            lastUpdate: Date.now()
        };
    }
    let gameState = getDefaultGameState();

    // ===============================================================
    // MOTEUR DE JEU
    // ===============================================================
    function getXpForLevel(level) { return Math.floor(100 * Math.pow(1.5, level - 1)); }

    function addXp(amount) {
        if (!amount || amount === 0) return;
        gameState.player.xp += amount;
        const xpForNextLevel = getXpForLevel(gameState.player.level);
        if (gameState.player.xp >= xpForNextLevel) {
            gameState.player.xp -= xpForNextLevel;
            gameState.player.level++;
            showToast(`üéâ NIVEAU SUP√âRIEUR ! Vous √™tes maintenant niveau ${gameState.player.level} !`, 'levelup');
        }
        checkQuestCompletion();
    }

    function saveGameState() {
        gameState.lastUpdate = Date.now();
        localStorage.setItem('imperiumCityState_v18', JSON.stringify(gameState));
    }

    function loadGameState() {
        const savedState = localStorage.getItem('imperiumCityState_v18');
        if (savedState) {
            gameState = { ...getDefaultGameState(), ...JSON.parse(savedState) };
            processOfflineProgress();
        }
        recalculateGameStats();
        updateAllUI();
    }

    function processOfflineProgress() {
        const now = Date.now();
        const offlineTime = (now - gameState.lastUpdate) / 1000;
        
        const processQueue = (queue, onComplete) => {
            const completedItems = [];
            (queue || []).forEach(item => {
                if (item.endTime <= now) {
                    onComplete(item);
                    completedItems.push(item);
                }
            });
            return (queue || []).filter(item => !completedItems.includes(item));
        };
        gameState.constructionQueue = processQueue(gameState.constructionQueue, completeConstruction);

        recalculateGameStats();
        for (const res in gameState.production) {
            if (gameState.resources[res] !== undefined) {
                const gain = (gameState.production[res] / 3600) * offlineTime;
                gameState.resources[res] = Math.min(gameState.resources[res] + gain, gameState.storage[res] || Infinity);
            }
        }
        showToast(`Bienvenue, Consul !`, 'success');
    }

    function gameTick() {
        const now = Date.now();
        const processQueue = (queue, onComplete) => {
            if (queue.length > 0 && now >= queue[0].endTime) {
                onComplete(queue[0]);
                queue.shift();
                recalculateGameStats();
                updateAllUI();
                saveGameState();
            }
        };
        processQueue(gameState.constructionQueue, completeConstruction);

        for (const res in gameState.production) {
            if (gameState.resources[res] !== undefined) {
                const gainPerSecond = (gameState.production[res] * gameState.stats.happinessModifier) / 3600;
                const currentRes = gameState.resources[res];
                const maxStorage = gameState.storage[res] || Infinity;
                if (currentRes < maxStorage && gainPerSecond > 0) {
                    gameState.resources[res] = Math.min(currentRes + gainPerSecond, maxStorage);
                } else if (gainPerSecond < 0) {
                    gameState.resources[res] += gainPerSecond;
                }
            }
        }
        
        if (gameState.stats.population < gameState.stats.populationCapacity && gameState.stats.happiness > 50) {
            const growthRate = (gameState.stats.happiness / 100) * 0.1; 
            gameState.stats.population = Math.min(gameState.stats.population + growthRate, gameState.stats.populationCapacity);
        } else if (gameState.stats.happiness < 20) {
            gameState.stats.population = Math.max(0, gameState.stats.population - 0.05);
        }

        updateDashboardPreviews();
        renderTimers();
    }

    function recalculateGameStats() {
        const baseProduction = { gold: 5, food: 10, marble: 2, happiness: 0, divineFavor: 0 };
        const baseStorage = { gold: 1000, food: 1500, marble: 500, divineFavor: 100 };
        let populationCapacity = 0;

        gameState.buildings.forEach(building => {
            if (building.type && building.level > 0) {
                const def = BUILDING_DEFINITIONS[building.type];
                if (def.production) {
                    for (const res in def.production) { baseProduction[res] += def.production[res] * building.level; }
                }
                if (def.storage) {
                    for (const res in def.storage) { baseStorage[res] += def.storage[res] * building.level; }
                }
                if (def.housing) {
                    populationCapacity += def.housing * building.level;
                }
            }
        });
        
        baseProduction.food -= Math.floor(gameState.stats.population / 10);

        gameState.production = baseProduction;
        gameState.storage = baseStorage;
        gameState.stats.populationCapacity = populationCapacity;
        
        if (gameState.stats.happiness > 90) {
            gameState.stats.happinessModifier = 1.1;
        } else if (gameState.stats.happiness < 30) {
            gameState.stats.happinessModifier = 0.75;
        } else {
            gameState.stats.happinessModifier = 1.0;
        }
    }

    // ===============================================================
    // FONCTIONS DE RENDU DE L'UI
    // ===============================================================
    function renderCityGrid() {
        const grid = document.getElementById('buildingsGrid');
        grid.innerHTML = '';
        gameState.buildings.forEach(building => {
            const slot = document.createElement('div');
            const isConstructing = gameState.constructionQueue.some(item => item.slotId === building.slotId);
            slot.className = `building-slot ${building.type ? 'occupied' : ''} ${isConstructing ? 'constructing' : ''}`;
            slot.dataset.slotId = building.slotId;
            
            if (isConstructing) {
                slot.innerHTML = `<div class="building-icon">üî®</div><div class="building-name">Construction...</div><div class="construction-timer"></div>`;
            } else if (building.type) {
                const def = BUILDING_DEFINITIONS[building.type];
                slot.innerHTML = `<div class="building-icon">${def.icon}</div><div class="building-name">${def.name}</div><div class="building-level">Niv. ${building.level}</div>`;
                slot.onclick = () => handleBuildingClick(building);
            } else {
                slot.innerHTML = `<div class="building-icon" style="font-size: 2.5rem; color: var(--gold-light);">+</div>`;
                slot.onclick = () => handleBuildingClick(building);
            }
            grid.appendChild(slot);
        });
        renderTimers();
    }
    
    function renderTimers() {
        const now = Date.now();
        document.querySelectorAll('.construction-timer').forEach(timerEl => {
            const slotEl = timerEl.closest('.building-slot');
            const slotId = parseInt(slotEl.dataset.slotId);
            const build = gameState.constructionQueue.find(item => item.slotId === slotId);
            if (build) {
                const remaining = Math.max(0, build.endTime - now);
                const seconds = Math.floor((remaining / 1000) % 60);
                const minutes = Math.floor((remaining / (1000 * 60)) % 60);
                const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24);
                timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        });
    }
    
    function updateDashboardPreviews() {
        document.getElementById('player-tile-preview').textContent = `Niveau ${gameState.player.level}`;
        document.getElementById('resources-tile-preview').textContent = `Or : ${Math.floor(gameState.resources.gold).toLocaleString()}`;
        document.getElementById('stats-tile-preview').textContent = `Population : ${Math.floor(gameState.stats.population).toLocaleString()}`;
        document.getElementById('production-tile-preview').textContent = `Or/h : ${Math.round(gameState.production.gold * gameState.stats.happinessModifier).toLocaleString()}`;
        const quest = QUESTS[gameState.activeQuestId];
        document.getElementById('quest-tile-preview').textContent = quest ? quest.description : "Termin√©";
    }

    function updateAllUI() {
        renderCityGrid();
        updateDashboardPreviews();
    }

    // ===============================================================
    // ACTIONS DE JEU
    // ===============================================================
    function getCost(baseCosts, multiplier, level) { 
        return baseCosts.map(cost => ({ res: cost.res, amount: Math.floor(cost.amount * Math.pow(multiplier, level)) })); 
    }
    function getBuildTime(baseTime, level) { return baseTime * Math.pow(1.6, level); }

    function handleBuildingClick(building) {
        if (gameState.constructionQueue.some(item => item.slotId === building.slotId)) {
            showToast("Ce b√¢timent est en cours de construction.", "error"); return;
        }
        if (BUILDING_DEFINITIONS[building.type]?.isInteractive) {
            // Future interactive buildings will go here
            return;
        }
        if (building.type) { // Occupied
            const def = BUILDING_DEFINITIONS[building.type];
            const upgradeCosts = getCost(def.baseCost, def.upgradeCostMultiplier, building.level);
            const canAfford = upgradeCosts.every(c => gameState.resources[c.res] >= c.amount);
            const costsHtml = upgradeCosts.map(c => `<span class="cost-item ${gameState.resources[c.res] < c.amount ? 'insufficient' : ''}">${c.amount.toLocaleString()} ${c.res}</span>`).join(', ');
            const time = getBuildTime(def.baseBuildTime, building.level);
            let bonusHtml = '';
            if (def.production) bonusHtml += `Production: ${Object.entries(def.production).map(([res, val]) => `+${val} ${res}/h`).join(', ')}`;
            if (def.storage) { if(bonusHtml) bonusHtml += '<br>'; bonusHtml += `Stockage: ${Object.entries(def.storage).map(([res, val]) => `+${val.toLocaleString()} ${res}`).join(', ')}`; }
            if (def.housing) { if(bonusHtml) bonusHtml += '<br>'; bonusHtml += `Logements: +${def.housing.toLocaleString()}`; }
            const body = `<p>${def.description}</p><p>Niveau actuel : <strong>${building.level}</strong></p>
                        <div class="upgrade-info">
                            <p><strong>Am√©lioration (Niv. ${building.level + 1}) :</strong></p>
                            <p>Co√ªt : ${costsHtml}</p>
                            <p>Temps : ${Math.floor(time)} secondes</p>
                            <p>Bonus : ${bonusHtml}</p>
                        </div>`;
            const footer = `<button class="imperium-btn danger" onclick="demolishBuilding(${building.slotId})">D√©truire</button>
                           <div>
                               <button class="imperium-btn" onclick="closeModal()">Fermer</button>
                               <button class="imperium-btn" onclick="startUpgrade(${building.slotId})" ${!canAfford || gameState.constructionQueue.length > 0 ? 'disabled' : ''}>Am√©liorer</button>
                           </div>`;
            showModal(`G√©rer ${def.name}`, body, footer);
        } else { // Empty
            const buildOptions = Object.entries(BUILDING_DEFINITIONS).map(([type, def]) => {
                const costs = getCost(def.baseCost, def.upgradeCostMultiplier, 0);
                let canAfford = true;
                let missingRes = "";
                for(const cost of costs) {
                    if(gameState.resources[cost.res] < cost.amount) {
                        canAfford = false;
                        missingRes = `${cost.amount - Math.floor(gameState.resources[cost.res])} ${cost.res}`;
                        break;
                    }
                }

                let prereqMet = true;
                let prereqText = '';
                if (def.requires) {
                    const requiredBuilding = gameState.buildings.find(b => b.type === def.requires.type);
                    if (!requiredBuilding || requiredBuilding.level < def.requires.level) {
                        prereqMet = false;
                        prereqText = `<div class="build-item-prereq">Requiert: ${BUILDING_DEFINITIONS[def.requires.type].name} Niv. ${def.requires.level}</div>`;
                    }
                }
                const costsHtml = costs.map(c => `<span class="cost-item ${gameState.resources[c.res] < c.amount ? 'insufficient' : ''}">${c.amount.toLocaleString()} ${c.res}</span>`).join(', ');
                return `<div class="build-item ${!canAfford || !prereqMet ? 'disabled' : ''}" ${canAfford && prereqMet ? `onclick="startBuild('${type}', ${building.slotId})"` : ''}>
                            <div class="build-item-icon">${def.icon}</div>
                            <div class="build-item-name">${def.name}</div>
                            <div class="build-item-costs">${costsHtml}</div>
                            ${prereqText}
                        </div>`;
            }).join('');
            const body = `<div class="build-grid">${buildOptions}</div>`;
            showModal('Construire un b√¢timent', body, '');
        }
    }

    function startBuild(type, slotId) {
        if (gameState.constructionQueue.length > 0) { showToast("File de construction occup√©e.", "error"); return; }
        const def = BUILDING_DEFINITIONS[type];
        const costs = getCost(def.baseCost, def.upgradeCostMultiplier, 0);
        
        for(const cost of costs) {
            if(gameState.resources[cost.res] < cost.amount) {
                showToast(`Ressources insuffisantes : il vous manque ${cost.amount - Math.floor(gameState.resources[cost.res])} ${cost.res}.`, "error");
                return;
            }
        }

        costs.forEach(c => gameState.resources[c.res] -= c.amount);
        const buildTime = getBuildTime(def.baseBuildTime, 0);
        gameState.constructionQueue.push({ slotId, type, level: 1, endTime: Date.now() + buildTime * 1000, xpGain: def.xpGain });
        updateAllUI();
        saveGameState();
        closeModal();
    }

    function startUpgrade(slotId) {
        if (gameState.constructionQueue.length > 0) { showToast("File de construction occup√©e.", "error"); return; }
        const building = gameState.buildings.find(b => b.slotId === slotId);
        const def = BUILDING_DEFINITIONS[building.type];
        const costs = getCost(def.baseCost, def.upgradeCostMultiplier, building.level);

        for(const cost of costs) {
            if(gameState.resources[cost.res] < cost.amount) {
                showToast(`Ressources insuffisantes : il vous manque ${cost.amount - Math.floor(gameState.resources[cost.res])} ${cost.res}.`, "error");
                return;
            }
        }
        
        costs.forEach(c => gameState.resources[c.res] -= c.amount);
        const buildTime = getBuildTime(def.baseBuildTime, building.level);
        gameState.constructionQueue.push({ slotId, type: building.type, level: building.level + 1, endTime: Date.now() + buildTime * 1000, xpGain: def.xpGain * (building.level + 1) });
        updateAllUI();
        saveGameState();
        closeModal();
    }
    
    function demolishBuilding(slotId) {
        const building = gameState.buildings.find(b => b.slotId === slotId);
        if (!building || !building.type) return;
        const def = BUILDING_DEFINITIONS[building.type];
        for(let i=0; i < building.level; i++){
            const costs = getCost(def.baseCost, def.upgradeCostMultiplier, i);
            costs.forEach(c => { gameState.resources[c.res] += c.amount * 0.5; });
        }
        building.type = null;
        building.level = 0;
        recalculateGameStats();
        updateAllUI();
        saveGameState();
        closeModal();
        showToast("B√¢timent d√©truit.", "success");
    }

    function completeConstruction(item) {
        const building = gameState.buildings.find(b => b.slotId === item.slotId);
        building.type = item.type;
        building.level = item.level;
        showToast(`${BUILDING_DEFINITIONS[item.type].name} (Niv. ${item.level}) termin√© !`, "success");
        addXp(item.xpGain);
    }

    function checkQuestCompletion() {
        const quest = QUESTS[gameState.activeQuestId];
        if (quest && quest.isComplete()) {
            showToast(`Objectif atteint : ${quest.description}`, "success");
            gameState.activeQuestId++;
            addXp(quest.reward.xp);
            quest.reward.resources.forEach(r => {
                gameState.resources[r.res] = Math.min(gameState.resources[r.res] + r.amount, gameState.storage[r.res] || Infinity);
            });
        }
    }

    function collectTaxes() {
        const gain = 500 + (gameState.stats.population * 0.5);
        if (gameState.resources.gold + gain > gameState.storage.gold) {
            showToast("L'entrep√¥t d'or est plein !", "error");
            gameState.resources.gold = gameState.storage.gold;
        } else {
            gameState.resources.gold += gain;
            showToast(`+${Math.floor(gain)} Or collect√© !`, 'success');
            addXp(10);
        }
        saveGameState();
    }

    function organizeGames() {
        const cost = 200;
        if (gameState.resources.gold < cost) { showToast("Pas assez d'or pour organiser des jeux.", "error"); return; }
        gameState.resources.gold -= cost;
        gameState.stats.happiness = Math.min(100, gameState.stats.happiness + 5);
        showToast(`Bonheur +5% !`, 'success');
        addXp(20);
        saveGameState();
    }
    
    // ===============================================================
    // UTILITAIRES
    // ===============================================================
    function showModal(title, body, footer) {
        const container = document.getElementById('modal-container');
        container.innerHTML = `<div class="modal-backdrop" onclick="closeModal()"></div><div class="modal-content"><div class="modal-header"><h3 class="modal-title">${title}</h3><button class="modal-close-btn" onclick="closeModal()">&times;</button></div><div class="modal-body">${body}</div><div class="modal-footer">${footer}</div></div>`;
        setTimeout(() => container.classList.add('active'), 10);
    }

    function closeModal() {
        const container = document.getElementById('modal-container');
        container.classList.remove('active');
        setTimeout(() => container.innerHTML = '', 300);
    }
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
    
    // ===============================================================
    // MODAL FUNCTIONS
    // ===============================================================
    function showPlayerModal() {
        const xpForNextLevel = getXpForLevel(gameState.player.level);
        const xpPercentage = (gameState.player.xp / xpForNextLevel) * 100;
        const body = `
            <div class="player-info" style="justify-content: center; background: none; border: none; padding: 0;">
                <div class="player-avatar" style="width: 80px; height: 80px; font-size: 2.5rem;">${gameState.player.avatar}</div>
                <div class="player-details" style="width: auto;">
                    <div class="player-name" style="font-size: 1.5rem;">${gameState.player.name}</div>
                    <div class="player-level" style="font-size: 1.1rem;">Niveau ${gameState.player.level}</div>
                    <div class="xp-bar-container" style="width: 200px;">
                        <div class="xp-bar-fill" style="width: ${xpPercentage}%;"></div>
                    </div>
                    <div class="xp-bar-text">${Math.floor(gameState.player.xp)} / ${xpForNextLevel} XP</div>
                </div>
            </div>
        `;
        showModal("Profil du Consul", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }

    function showResourcesModal() {
        let body = '<div class="resources-display">';
        for (const res in gameState.resources) {
            const current = Math.floor(gameState.resources[res]);
            const max = gameState.storage[res] || Infinity;
            const icon = {'gold':'üí∞','food':'üåæ','marble':'üèõÔ∏è','divineFavor':'üôè'}[res];
            body += `
                <div class="resource-item">
                    <span class="resource-icon">${icon}</span>
                    <span>${res.charAt(0).toUpperCase() + res.slice(1)}</span>
                    <span class="resource-value ${current >= max ? 'full' : ''}">${current.toLocaleString()}/${max.toLocaleString()}</span>
                </div>
            `;
        }
        body += '</div>';
        showModal("Inventaire des Ressources", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }

    function showStatsModal() {
        const body = `
            <div class="city-stats">
                <div class="stat-item">
                    <div class="stat-value">${Math.floor(gameState.stats.population).toLocaleString()}/${gameState.stats.populationCapacity.toLocaleString()}</div>
                    <div class="stat-label">üë• Population</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${gameState.stats.happiness}%</div>
                    <div class="stat-label">üòä Bonheur</div>
                </div>
            </div>
        `;
        showModal("Statistiques de la Cit√©", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }

    function showProductionModal() {
        let body = '<div class="production-display">';
        body += Object.entries(gameState.production).filter(([res]) => ['gold', 'food', 'marble'].includes(res)).map(([res, rate]) => {
            const iconMap = { gold: 'ÔøΩ', food: 'üåæ', marble: 'üèõÔ∏è' };
            const effectiveRate = rate * gameState.stats.happinessModifier;
            const rateClass = effectiveRate >= 0 ? 'positive' : 'negative';
            const sign = effectiveRate >= 0 ? '+' : '';
            return `<div class="production-item"><div class="production-resource"><span>${iconMap[res]}</span> ${res.charAt(0).toUpperCase() + res.slice(1)}</div><div class="production-rate ${rateClass}">${sign}${Math.round(effectiveRate).toLocaleString()}</div></div>`;
        }).join('');
        body += '</div>';
        showModal("Rapport de Production", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }
    
    function showQuestModal() {
        const quest = QUESTS[gameState.activeQuestId];
        let body = '';
        if (quest) {
            const rewardText = quest.reward.resources.map(r => `${r.amount.toLocaleString()} ${r.res}`).join(', ') + (quest.reward.xp > 0 ? ` & ${quest.reward.xp} XP` : '');
            body = `<div class="quest-panel"><div class="quest-title">${quest.description}</div><div class="quest-reward">R√©compense : ${rewardText}</div></div>`;
        } else {
            body = `<div class="quest-panel"><div class="quest-title">Toutes les qu√™tes sont termin√©es !</div></div>`;
        }
        showModal("Objectif Actuel", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }
    
    function showActionsModal() {
        const body = `
            <div class="quick-actions" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                <button class="imperium-btn" onclick="collectTaxes(); closeModal();">üí∞ Collecter Imp√¥ts</button>
                <button class="imperium-btn" onclick="organizeGames(); closeModal();">üé™ Organiser Jeux</button>
            </div>
        `;
        showModal("Actions Rapides", body, `<button class="imperium-btn" onclick="closeModal()">Fermer</button>`);
    }

    // ===============================================================
    // INITIALISATION
    // ===============================================================
    document.addEventListener('DOMContentLoaded', function() {
        loadGameState();
        setInterval(gameTick, 1000);
        setInterval(saveGameState, 30000);
        const navButton = document.getElementById('navButton');
        const navPopup = document.getElementById('navPopup');
        navButton.addEventListener('click', () => {
            navPopup.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if (!navPopup.contains(e.target) && e.target !== navButton) {
                navPopup.classList.remove('active');
            }
        });
    });
    </script>
</body>
</html>
