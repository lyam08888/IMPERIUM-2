<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚔️ IMPERIUM - Simulateur de Combat V18 ⚔️</title>

    <!-- Stylesheets centralisés -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/imperium_popup.css">
    <link rel="stylesheet" href="css/loader.css">

    <!-- Scripts de jeu -->
    <script src="js/game.js" defer></script>
    <script src="js/simulator-view.js" defer></script>
    <script src="nav.js" defer></script>
    <script src="js/imperium_popup.js" defer></script>

    <style>
    :root {
        --gold-primary: #d97706; --gold-secondary: #f59e0b; --gold-light: #fbbf24;
        --marble-white: #f8fafc; --roman-red: #dc2626; --roman-purple: #7c3aed;
        --dark-stone: #1e293b; --dark-marble: #334155; --dark-bg: #0f172a;
        --text-light: #e2e8f0; --text-muted: #94a3b8;
        --border-gold: rgba(217, 119, 6, 0.3); --shadow-gold: rgba(217, 119, 6, 0.4);
        --success-green: #22c55e; --storage-full-red: #ef4444;
        --info-blue: #3b82f6;
        --morale-high: #22c55e; --morale-medium: #f59e0b; --morale-low: #ef4444;
        --xp-bar: #3b82f6;
        --loyalty-bar: #a855f7;
        --supply-bar: #84cc16;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    body {
        font-family: 'Times New Roman', serif;
        background: radial-gradient(circle at 20% 20%, rgba(217, 119, 6, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                    linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
        color: var(--text-light);
        min-height: 100vh;
        padding: 1rem;
        overflow-x: hidden;
    }
    .imperium-body { flex-grow: 1; max-width: 1600px; margin: 0 auto; width: 100%; }
    .main-content { position: relative; }
    .view-container { background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); border-radius: 1rem; border: 1px solid var(--border-gold); padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .view-title { font-size: 2.2rem; font-weight: bold; color: var(--gold-primary); margin-bottom: 1rem; text-align: center; }
    
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(15, 23, 42, 0.8); padding: 0.5rem 1.5rem; border-radius: 0.8rem; margin-bottom: 1rem; }
    .resources-display { display: flex; gap: 1.5rem; }
    .resource-item { display: flex; align-items: center; gap: 0.5rem; font-weight: bold; }

    .simulator-layout { display: flex; flex-direction: column; gap: 1rem; }
    .battle-setup { display: grid; grid-template-columns: 1fr; gap: 1rem; align-items: start; }
    @media (min-width: 1024px) { .battle-setup { grid-template-columns: 1fr 1fr; } }
    .army-setup { background: rgba(15, 23, 42, 0.8); border-radius: 1rem; border: 2px solid var(--border-gold); padding: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .army-setup.attacker { border-color: var(--roman-red); }
    .army-setup.defender { border-color: var(--success-green); }
    .army-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; text-align: center; }
    .unit-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .unit-selector { background: rgba(30, 41, 59, 0.6); border-radius: 0.8rem; border: 1px solid var(--border-gold); padding: 0.75rem; text-align: center; position: relative; transition: all 0.2s ease-in-out; }
    .unit-selector:hover { transform: translateY(-3px); box-shadow: 0 4px 10px var(--shadow-gold); }
    .unit-icon { font-size: 2rem; margin-bottom: 0.25rem; }
    .unit-name { color: var(--gold-light); font-weight: bold; margin-bottom: 0.5rem; font-size: 0.8rem; }
    .unit-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-gold); color: var(--text-light); text-align: center; padding: 0.5rem; border-radius: 0.3rem; }
    .unit-available { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }
    .advanced-settings { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-gold); }
    .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; position: relative; }
    .setting-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border-gold); color: var(--text-light); padding: 0.5rem; border-radius: 0.3rem; flex-grow: 1; }

    .battle-controls { background: rgba(15, 23, 42, 0.8); border-radius: 1rem; padding: 1rem; text-align: center; }
    .global-conditions { display: flex; justify-content: space-around; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .simulate-btn { padding: 0.8rem 1.5rem; background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary)); color: white; border: none; border-radius: 0.8rem; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
    .simulate-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--shadow-gold); }
    .simulate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .small-btn { font-size: 0.9rem; padding: 0.4rem 0.8rem; border-radius: 0.5rem; color: white; transition: transform 0.2s, background-color 0.2s; border: none; cursor: pointer; }
    .small-btn:hover { transform: scale(1.05); }
    #reset-btn { background: var(--dark-marble); }
    #random-config-btn { background: var(--info-blue); }
    #scout-btn { background: var(--gold-secondary); }
    #simulation-status { color: var(--text-muted); font-style: italic; height: 1.2em; text-align: center; margin-top: 0.5rem; }
    .battle-result { background: rgba(15, 23, 42, 0.9); border-radius: 1rem; border: 2px solid var(--gold-primary); padding: 2rem; margin-top: 1rem; display: none; }
    .battle-result.show { display: block; animation: slideInUp 0.5s ease; }
    .battle-result.victory { border-color: var(--success-green); }
    .battle-result.defeat { border-color: var(--roman-red); }
    .result-header { text-align: center; margin-bottom: 2rem; }
    .result-title { font-size: 2.5rem; font-weight: bold; }
    .result-details { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 768px) { .result-details { grid-template-columns: 1fr 1fr; } }
    .result-section-title { color: var(--gold-primary); font-weight: bold; margin-bottom: 1rem; }
    .losses-list, .loot-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .loss-item, .loot-item { display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 0.3rem; }
    .loss-count { color: var(--roman-red); font-weight: bold; }
    .loot-amount { color: var(--success-green); font-weight: bold; }
    .battle-report { background: rgba(0,0,0,0.3); border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; max-height: 250px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; grid-column: 1 / -1; }
    .stat-bar-container { width: 100%; height: 10px; background-color: #444; border-radius: 5px; margin-top: 0.5rem; margin-bottom: 1rem; overflow: hidden; }
    .stat-bar { height: 100%; width: 100%; transition: width 0.5s ease, background-color 0.5s ease; }
    #attacker-loyalty-bar { background-color: var(--loyalty-bar); }
    #attacker-supply-bar { background-color: var(--supply-bar); }
    .hero-ability-btn { background: var(--roman-purple); color: white; border: 1px solid var(--gold-light); padding: 0.5rem; border-radius: 0.5rem; margin-top: 0.5rem; cursor: pointer; display: none; }
    .hero-ability-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #weather-indicator { text-align: center; font-size: 1.5rem; }
    .xp-bar { width: 90%; height: 4px; background-color: #444; border-radius: 2px; margin-top: 3px; overflow: hidden; }
    .xp-bar-inner { height: 100%; width: 0%; background-color: var(--xp-bar); transition: width 0.5s ease; }
    .rank-indicator { font-size: 0.7rem; color: var(--gold-light); font-weight: bold; }

    #battle-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    #battle-modal-content { background: var(--dark-bg); border: 2px solid var(--gold-primary); border-radius: 1rem; padding: 2rem; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
    .modal-footer { margin-top: 1rem; text-align: center; }

    @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>
    <div id="loader">
        <div class="loader-spinner"></div>
    </div>
    <!-- Le contenu de nav.html sera injecté ici par nav.js -->
<div id="view-simulator">
    <div class="imperium-body">
        <main class="main-content">
            <div class="view-container">
                <h1 class="view-title">⚔️ IMPERIUM - Simulateur de Combat V18 ⚔️</h1>
                <div class="simulator-layout">
                    <div class="battle-setup">
                        <div class="army-setup attacker">
                            <h3 class="army-title army-title-attacker">Armée Attaquante</h3>
                            <div class="advanced-settings">
                                <div class="setting-item">
                                    <label for="attacker-hero">Héros :</label>
                                    <select id="attacker-hero" class="setting-select"></select>
                                </div>
                                <button id="attacker-hero-ability" class="hero-ability-btn">Utiliser Compétence</button>
                                <div class="setting-item">
                                    <label for="attacker-formation">Formation :</label>
                                    <select id="attacker-formation" class="setting-select"></select>
                                </div>
                                 <div class="setting-item">
                                    <label for="attacker-artefact">Artefact :</label>
                                    <select id="attacker-artefact" class="setting-select"></select>
                                </div>
                            </div>
                            <label>Moral:</label><div class="stat-bar-container"><div id="attacker-morale-bar" class="stat-bar"></div></div>
                            <label>Ravitaillement:</label><div class="stat-bar-container"><div id="attacker-supply-bar" class="stat-bar"></div></div>
                            <div class="unit-selection" id="attacker-units"></div>
                        </div>

                        <div class="army-setup defender">
                            <h3 class="army-title army-title-defender">Armée Défenseure</h3>
                            <label>Moral:</label><div class="stat-bar-container"><div id="defender-morale-bar" class="stat-bar"></div></div>
                             <div class="advanced-settings">
                                <div class="setting-item">
                                    <label for="defender-hero">Héros :</label>
                                    <select id="defender-hero" class="setting-select"></select>
                                </div>
                                <div class="setting-item">
                                    <label for="defender-formation">Formation :</label>
                                    <select id="defender-formation" class="setting-select"></select>
                                </div>
                                <div class="setting-item">
                                    <label for="wall-level">Niveau Muraille :</label>
                                    <input type="number" id="wall-level" class="unit-input setting-input" value="5" min="0" max="20">
                                </div>
                            </div>
                            <div class="unit-selection" id="defender-units"></div>
                        </div>
                    </div>

                    <div class="battle-controls">
                        <div class="global-conditions">
                            <div id="weather-indicator">☀️ Temps Clair</div>
                            <div class="setting-item" style="flex-direction: column; gap: 0.5rem; width:180px;">
                                <label for="terrain">Terrain :</label>
                                <select id="terrain" class="setting-select"></select>
                            </div>
                            <div class="setting-item" style="flex-direction: column; gap: 0.5rem; width:180px;">
                                <label for="decree">Décret Impérial :</label>
                                <select id="decree" class="setting-select"></select>
                            </div>
                        </div>
                        <button class="simulate-btn" id="simulate-battle" disabled>LANCER L'ASSAUT</button>
                        <div id="simulation-status">Veuillez ajouter des unités</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem;">
                            <button class="small-btn" id="scout-btn">Éclaireur</button>
                            <button class="small-btn" id="random-config-btn">Aléatoire</button>
                            <button class="small-btn" id="reset-btn">Réinitialiser</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="battle-modal-overlay">
    <div id="battle-modal-content">
        <div id="battle-result" class="battle-result">
            <div class="result-header"><div id="result-title" class="result-title"></div></div>
            <div class="result-details">
                <div><h4 class="result-section-title">Pertes Attaquant</h4><div id="attacker-losses" class="losses-list"></div></div>
                <div><h4 class="result-section-title">Pertes Défenseur</h4><div id="defender-losses" class="losses-list"></div></div>
                <div id="loot-section"><h4 class="result-section-title">Butin</h4><div id="battle-loot" class="loot-list"></div></div>
            </div>
        </div>
        <div class="battle-report" id="battle-report"></div>
        <div class="modal-footer">
            <button class="small-btn" id="skip-battle-btn">Passer</button>
            <button class="small-btn" id="close-modal-btn" style="display:none;">Fermer</button>
        </div>
    </div>
</div>

<script src="js/combat-simulator.js" defer></script>
    <!-- La popup IMPERIUM sera injectée ici par imperium_popup.js -->
    <script>
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
            document.getElementById('view-simulator').classList.add('content-fade-in');
        });
    </script>
</body>
</html>
