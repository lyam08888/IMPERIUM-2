// js/intro-fixed.js
// Version corrig√©e avec gestion d'erreur et Battle Pass int√©gr√©

// D√©tection du mode mobile
function isMobile() {
    return /Mobi|Android/i.test(navigator.userAgent);
}

// Fonction de d√©bogage pour traquer les probl√®mes
function debugLog(message, data = null) {
    console.log(`[INTRO DEBUG] ${message}`, data || '');
}

// Fonction de s√©curit√© pour redirection
function safeRedirect(url, fallbackUrl = 'imperium-mobile-clean.html') {
    try {
        debugLog(`Tentative de redirection vers: ${url}`);
        window.location.href = url;
    } catch (error) {
        debugLog(`Erreur de redirection, utilisation du fallback: ${fallbackUrl}`, error);
        window.location.href = fallbackUrl;
    }
}

// Make sure to wait for the DOM to be ready
document.addEventListener('DOMContentLoaded', () => {
    debugLog('DOM charg√©, initialisation de l\'intro...');

    // --- Constants and DOM Elements ---
    const SAVE_KEY = 'imperium_v19_gamestate';
    
    // V√©rification des √©l√©ments DOM
    const titleScreen = document.getElementById('title-screen');
    const cinematicScreen = document.getElementById('cinematic-screen');
    const tutorialScreen = document.getElementById('tutorial-screen');
    const introButtonsContainer = document.getElementById('intro-buttons');
    
    if (!titleScreen || !cinematicScreen || !tutorialScreen || !introButtonsContainer) {
        debugLog('ERREUR: √âl√©ments DOM manquants!', {
            titleScreen: !!titleScreen,
            cinematicScreen: !!cinematicScreen,
            tutorialScreen: !!tutorialScreen,
            introButtonsContainer: !!introButtonsContainer
        });
        
        // Redirection de s√©curit√© vers le jeu principal
        setTimeout(() => safeRedirect('imperium-mobile-clean.html'), 2000);
        return;
    }
    
    const loadingBar = document.getElementById('loading-bar');
    const cinematicText = document.getElementById('cinematic-text');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');

    debugLog('Tous les √©l√©ments DOM trouv√©s');

    // --- Fonctions de cr√©ation de boutons s√©curis√©es ---
    function createButton(text, className, clickHandler, styles = {}) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        
        // Appliquer les styles personnalis√©s
        Object.assign(button.style, styles);
        
        // Gestionnaire de clic avec gestion d'erreur
        button.addEventListener('click', (e) => {
            try {
                debugLog(`Bouton cliqu√©: ${text}`);
                clickHandler(e);
            } catch (error) {
                debugLog(`Erreur dans le gestionnaire de clic pour "${text}"`, error);
                
                // Fallback - rediriger vers le jeu principal
                if (text.includes('Jouer') || text.includes('Direct')) {
                    safeRedirect('imperium-mobile-clean.html');
                }
            }
        });
        
        // Ajouter des attributs pour le d√©bogage
        button.setAttribute('data-button-type', text.toLowerCase().replace(/\s+/g, '-'));
        
        return button;
    }

    // --- Gestion des boutons avec alternatives multiples ---
    function createGameStartButtons() {
        debugLog('Cr√©ation des boutons de d√©marrage...');
        
        const startBtn = createButton(
            'üèõÔ∏è Commencez √† Jouer', 
            'imperium-btn',
            startIntroSequence,
            { fontSize: '1.2em', marginBottom: '15px' }
        );
        
        const directBtn = createButton(
            '‚ö° Jeu Direct (Sans Tutoriel)', 
            'imperium-btn', 
            handleDirectGame,
            { 
                marginTop: '10px', 
                background: '#16a34a',
                fontSize: '1.1em'
            }
        );
        
        const unifiedBtn = createButton(
            'üåü Version Unifi√©e (Recommand√©)', 
            'imperium-btn', 
            () => safeRedirect('imperium-unified.html'),
            { 
                marginTop: '10px', 
                background: '#8b5cf6',
                fontSize: '1.1em'
            }
        );
        
        const battlePassBtn = createButton(
            'üéñÔ∏è Battle Pass (Nouveau!)', 
            'imperium-btn', 
            showBattlePass,
            { 
                marginTop: '10px', 
                background: '#f59e0b',
                fontSize: '1.1em',
                border: '2px solid #fbbf24'
            }
        );
        
        return { startBtn, directBtn, unifiedBtn, battlePassBtn };
    }

    function createContinueButtons() {
        debugLog('Cr√©ation des boutons de continuation...');
        
        const continueBtn = createButton(
            '‚ñ∂Ô∏è Continuer la partie', 
            'imperium-btn',
            () => safeRedirect('game.html')
        );
        
        const newGameBtn = createButton(
            'üîÑ Nouvelle Partie', 
            'imperium-btn danger',
            handleNewGame
        );
        
        const battlePassBtn = createButton(
            'üéñÔ∏è Voir mon Battle Pass', 
            'imperium-btn', 
            showBattlePass,
            { 
                marginTop: '10px', 
                background: '#f59e0b',
                border: '2px solid #fbbf24'
            }
        );
        
        return { continueBtn, newGameBtn, battlePassBtn };
    }

    // --- Gestionnaires d'√©v√©nements s√©curis√©s ---
    function handleDirectGame() {
        debugLog('Gestion du jeu direct...');
        
        const confirmMessage = `üéÆ Aller directement au jeu principal ?

‚úÖ Vous commencerez avec :
‚Ä¢ Une ferme d√©j√† construite
‚Ä¢ Des ressources de base
‚Ä¢ Battle Pass actif (niveau 1)
‚Ä¢ Aucun tutoriel

‚ö° Recommand√© pour les joueurs exp√©riment√©s`;
        
        if (confirm(confirmMessage)) {
            try {
                skipTutorialCompletely();
            } catch (error) {
                debugLog('Erreur dans skipTutorialCompletely, redirection directe', error);
                safeRedirect('game.html');
            }
        }
    }
    
    function handleNewGame() {
        debugLog('Gestion de nouvelle partie...');
        
        const confirmMessage = `‚ö†Ô∏è √ätes-vous s√ªr de vouloir commencer une nouvelle partie ?

üî• Cette action va :
‚Ä¢ Effacer votre sauvegarde actuelle
‚Ä¢ R√©initialiser votre Battle Pass
‚Ä¢ Perdre tous vos progr√®s

Cette action est IRR√âVERSIBLE !`;
        
        if (confirm(confirmMessage)) {
            try {
                localStorage.removeItem(SAVE_KEY);
                localStorage.removeItem('imperium_battle_pass');
                localStorage.removeItem('imperium_inventory');
                debugLog('Sauvegardes supprim√©es, d√©marrage nouveau jeu...');
                startIntroSequence();
            } catch (error) {
                debugLog('Erreur lors de la suppression, redirection de s√©curit√©', error);
                safeRedirect('game.html');
            }
        }
    }

    function showBattlePass() {
        debugLog('Affichage du Battle Pass...');
        
        try {
            if (window.battlePassSystem) {
                window.battlePassSystem.showBattlePassUI();
            } else {
                // Fallback si le Battle Pass n'est pas encore charg√©
                setTimeout(() => {
                    if (window.battlePassSystem) {
                        window.battlePassSystem.showBattlePassUI();
                    } else {
                        alert('üéñÔ∏è Battle Pass en cours de chargement...\nVeuillez patienter quelques secondes et r√©essayer.');
                    }
                }, 1000);
            }
        } catch (error) {
            debugLog('Erreur affichage Battle Pass', error);
            alert('üéñÔ∏è Le Battle Pass sera disponible dans le jeu principal !');
        }
    }

    // --- Check for Saved Game ---
    function initializeIntro() {
        debugLog('Initialisation de l\'intro...');
        introButtonsContainer.innerHTML = ''; // R√©initialiser le conteneur

        try {
            const savedGame = localStorage.getItem(SAVE_KEY);

            if (savedGame) {
                const { continueBtn, newGameBtn, battlePassBtn } = createContinueButtons();
                introButtonsContainer.appendChild(continueBtn);
                introButtonsContainer.appendChild(newGameBtn);
                introButtonsContainer.appendChild(battlePassBtn);
            } else {
                const { startBtn, directBtn, unifiedBtn, battlePassBtn } = createGameStartButtons();
                introButtonsContainer.appendChild(startBtn);
                introButtonsContainer.appendChild(directBtn);
                introButtonsContainer.appendChild(unifiedBtn);
                introButtonsContainer.appendChild(battlePassBtn);
            }

            // Ajouter le bouton d'urgence apr√®s avoir rendu les boutons principaux
            addEmergencyButton();
        } catch (error) {
            debugLog('Erreur lors de l\'initialisation des boutons', error);
            // Fallback simple vers la version unifi√©e
            const fallbackBtn = createButton(
                'üèõÔ∏è Commencer √† jouer',
                'imperium-btn',
                () => safeRedirect('imperium-unified.html'),
                { fontSize: '1.3em', padding: '15px 30px' }
            );
            introButtonsContainer.appendChild(fallbackBtn);
        }
    }
    
    function addEmergencyButton() {
        // Bouton cach√© d'urgence (visible apr√®s 10 secondes)
        setTimeout(() => {
            if (document.querySelector('.emergency-access')) return; // D√©j√† ajout√©
            
            const emergencyBtn = createButton(
                'üõ†Ô∏è Acc√®s de D√©bogage', 
                'imperium-btn emergency-access',
                showDebugMenu,
                { 
                    background: '#6366f1',
                    fontSize: '0.9em',
                    marginTop: '20px',
                    opacity: '0.7'
                }
            );
            
            introButtonsContainer.appendChild(emergencyBtn);
        }, 10000);
    }
    
    function showDebugMenu() {
        const debugOptions = `üõ†Ô∏è MENU DE D√âBOGAGE

Choisissez une action :
1 - Aller au jeu principal
2 - Version unifi√©e
3 - Effacer toutes les donn√©es
4 - Tester le Battle Pass
5 - Annuler`;
        
        const choice = prompt(debugOptions);
        
        switch (choice) {
            case '1':
                safeRedirect('game.html');
                break;
            case '2':
                safeRedirect('imperium-unified.html');
                break;
            case '3':
                if (confirm('‚ö†Ô∏è Effacer TOUTES les donn√©es ?')) {
                    localStorage.clear();
                    location.reload();
                }
                break;
            case '4':
                showBattlePass();
                break;
            default:
                break;
        }
    }

    // --- Intro Flow avec gestion d'erreur ---
    function startIntroSequence() {
        debugLog('D√©marrage de la s√©quence d\'intro...');
        
        try {
            titleScreen.classList.add('hidden');
            cinematicScreen.classList.remove('hidden');
            runCinematic();
        } catch (error) {
            debugLog('Erreur dans startIntroSequence, redirection directe', error);
            safeRedirect('game.html');
        }
    }

    function runCinematic() {
        debugLog('Lancement de la cin√©matique...');
        
        try {
            setTimeout(() => {
                if (loadingBar) loadingBar.style.width = '100%';
                if (cinematicText) cinematicText.textContent = 'La fondation de Rome...';
            }, 100);

            setTimeout(() => {
                cinematicScreen.classList.add('hidden');
                tutorialScreen.classList.remove('hidden');
                startTutorial();
            }, 2500);
        } catch (error) {
            debugLog('Erreur dans la cin√©matique, passage au jeu', error);
            safeRedirect('game.html');
        }
    }

    // --- Tutorial Logic avec fallbacks ---
    let tutorialState = {
        gameState: null,
        currentStep: 0,
        targetSlotId: -1,
    };

    const tutorialSteps = [
        {
            message: "üèõÔ∏è Bienvenue, Consul ! Pour commencer, nous devons nourrir notre peuple. Construisons une ferme. <br><br>Cliquez sur un terrain vide pour commencer.<br><br>‚ö†Ô∏è <strong>Si rien ne se passe, utilisez le bouton 'PASSER LE TUTORIEL' ci-dessous.</strong>",
            action: 'clickEmptyPlot',
            highlight: '#tutorialBuildingsGrid .building-slot:not(.occupied)',
            showButton: false,
        },
        {
            message: "‚ú® Parfait ! Voici les b√¢timents disponibles. S√©lectionnez la <strong>üåæ Ferme</strong>.",
            action: 'selectBuilding',
            highlight: '.build-item[data-building-type="farm"]',
            showButton: false,
        },
        {
            message: "üèóÔ∏è Excellent choix ! La construction a commenc√©. Pendant ce temps, d√©couvrons les ressources et le <strong>üéñÔ∏è Battle Pass</strong> !",
            action: 'wait',
            showButton: true,
        },
        {
            message: "üí∞ Voici vos ressources principales : Or, Nourriture et Marbre. La ferme produit de la nourriture et vous donne de l'XP pour votre Battle Pass !",
            action: 'highlightElement',
            highlight: '#tutorial-resources',
            showButton: true,
        },
        {
            message: "üéâ Construction termin√©e ! Votre ferme produit maintenant des ressources et vous avez gagn√© vos premiers points XP Battle Pass !",
            action: 'autoAdvance',
            showButton: false,
        },
        {
            message: "üéØ F√©licitations ! Premier objectif compl√©t√©. Le syst√®me d'objectifs vous guide et offre des r√©compenses Battle Pass !",
            action: 'highlightElement',
            highlight: '#tutorial-objectives-tile',
            showButton: true,
        },
        {
            message: "üéñÔ∏è Votre empire grandit ! Vous d√©bloquez maintenant le <strong>Battle Pass Imp√©rial</strong> avec 100 niveaux de r√©compenses. Bonne chance, Consul !",
            action: 'finish',
            showButton: true,
        }
    ];

    function startTutorial() {
        debugLog('D√©marrage du tutoriel...');
        
        try {
            tutorialState.gameState = getDefaultGameState();
            renderTutorialGrid();
            renderTutorialResources();
            
            createSkipTutorialButton();
            runTutorialStep(0);
            
            // Initialisation du Battle Pass pour le tutoriel
            if (window.battlePassSystem) {
                window.battlePassSystem.addXP(50); // XP de d√©marrage
            }
            
        } catch (error) {
            debugLog('Erreur dans startTutorial', error);
            // Passer directement au jeu en cas d'erreur
            skipTutorialCompletely();
        }
    }
    
    function createSkipTutorialButton() {
        debugLog('Cr√©ation du bouton Passer le Tutoriel...');
        
        if (!document.getElementById('fixed-skip-tutorial-btn')) {
            const skipBtn = document.createElement('button');
            skipBtn.id = 'fixed-skip-tutorial-btn';
            skipBtn.textContent = '‚ùå PASSER LE TUTORIEL';
            skipBtn.className = 'imperium-btn danger';
            skipBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                font-size: 1.2em;
                font-weight: bold;
                padding: 12px 20px;
                background: #dc2626;
                border: 2px solid #fbbf24;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                animation: pulse 2s infinite;
            `;
            
            skipBtn.onclick = () => {
                const confirmMessage = `üéÆ Passer le tutoriel ?

‚úÖ Vous irez directement au jeu avec :
‚Ä¢ Une ferme d√©j√† construite
‚Ä¢ Des ressources de d√©marrage  
‚Ä¢ Battle Pass niveau 1 activ√©
‚Ä¢ Premier objectif compl√©t√©

‚ö° Recommand√© si vous connaissez d√©j√† le jeu !`;
                
                if (confirm(confirmMessage)) {
                    skipTutorialCompletely();
                }
            };
            
            document.body.appendChild(skipBtn);
            debugLog('Bouton Passer le Tutoriel cr√©√©');
        }
    }
    
    function skipTutorialCompletely() {
        debugLog('Passage complet du tutoriel...');
        
        try {
            // Create completed tutorial state
            const completedState = getDefaultGameState();
            
            // Add a farm to the first slot
            completedState.city.buildings[0].type = 'farm';
            completedState.city.buildings[0].level = 1;
            
            // Give resources as if the farm has been producing
            completedState.resources.food = 200;
            completedState.resources.gold = 150;
            completedState.resources.marble = 100;
            
            // Mark first quest as completed
            completedState.city.activeQuestId = 1;
            
            // Add some progress
            completedState.player.xp = 50;
            
            // Initialize Battle Pass data
            if (window.battlePassSystem) {
                window.battlePassSystem.addXP(100); // XP bonus pour avoir pass√© le tutoriel
            }
            
            // Save and redirect
            localStorage.setItem(SAVE_KEY, JSON.stringify(completedState));
            debugLog("Tutoriel pass√© - √©tat sauvegard√©, redirection...");
            
            safeRedirect('game.html');
            
        } catch (error) {
            debugLog('Erreur dans skipTutorialCompletely', error);
            // Redirection de s√©curit√© m√™me en cas d'erreur
            safeRedirect('game.html');
        }
    }

    // --- Fonctions utilitaires manquantes ---
    function getDefaultGameState() {
        // Cette fonction doit retourner l'√©tat de jeu par d√©faut
        // Si la fonction n'existe pas dans game.js, on cr√©e une version basique
        if (typeof window.getDefaultGameState === 'function') {
            return window.getDefaultGameState();
        }
        
        // Version de secours
        return {
            player: { name: "Consul", level: 1, xp: 0 },
            resources: { gold: 100, food: 50, marble: 25 },
            city: {
                buildings: Array(12).fill().map((_, i) => ({ slotId: i, type: null, level: 0 })),
                activeQuestId: 0,
                constructionQueue: []
            }
        };
    }
    
    function renderTutorialGrid() {
        debugLog('Rendu de la grille tutoriel...');
        // Impl√©mentation basique si n√©cessaire
    }
    
    function renderTutorialResources() {
        debugLog('Rendu des ressources tutoriel...');
        // Impl√©mentation basique si n√©cessaire
    }
    
    function runTutorialStep(stepIndex) {
        debugLog(`√âtape tutoriel: ${stepIndex}`);
        // Version simplifi√©e pour √©viter les erreurs
        if (stepIndex >= tutorialSteps.length) {
            skipTutorialCompletely();
            return;
        }
        
        const step = tutorialSteps[stepIndex];
        const tutorialMessage = document.getElementById('tutorial-message');
        
        if (tutorialMessage) {
            tutorialMessage.innerHTML = step.message;
        }
        
        // Auto-avancer apr√®s quelques √©tapes pour √©viter les blocages
        if (stepIndex > 2) {
            setTimeout(() => {
                runTutorialStep(stepIndex + 1);
            }, 3000);
        }
    }

    // --- Initialisation finale ---
    try {
        initializeIntro();
        debugLog('Initialisation termin√©e avec succ√®s');
        
        // V√©rification de la disponibilit√© du Battle Pass apr√®s un d√©lai
        setTimeout(() => {
            if (!window.battlePassSystem) {
                debugLog('ATTENTION: Battle Pass System non trouv√© !');
            } else {
                debugLog('Battle Pass System disponible');
            }
        }, 2000);
        
    } catch (error) {
        debugLog('ERREUR CRITIQUE dans l\'initialisation', error);
        
        // Interface de secours
        if (introButtonsContainer) {
            introButtonsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; background: rgba(220, 38, 38, 0.1); border: 2px solid #dc2626; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #dc2626;">üö® Mode de Secours</h3>
                    <p>Une erreur a √©t√© d√©tect√©e. Utilisez les liens ci-dessous :</p>
                    <button onclick="window.location.href='game.html'" class="imperium-btn" style="margin: 10px;">üéÆ Jeu Principal</button>
                    <button onclick="window.location.href='imperium-unified.html'" class="imperium-btn" style="margin: 10px;">üåü Version Unifi√©e</button>
                    <button onclick="location.reload()" class="imperium-btn" style="margin: 10px;">üîÑ Recharger</button>
                </div>
            `;
        }
    }
});

// Export global pour compatibilit√©
window.introSystem = {
    skipTutorialCompletely,
    safeRedirect,
    debugLog
};